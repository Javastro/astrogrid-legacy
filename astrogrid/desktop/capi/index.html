<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>C API to the AstroRuntime</title>
</head>
<body>
<h1>C API to the AstroRuntime</h1>
<p>This directory contains the source code for the C API of the AstroGrid AstroRuntime.  </p>
<h2>Compiling the Code</h2>
<p>The code is built using the cross platform <a href="http://www.cmake.org/">cmake</a> utility - you will need to follow the installation instructions for this utility before you can proceed.</p>
<p>Once cmake is installed then you can follow the istructions below</p>
<ol>
<li>Run the cmake utility - the exact form of the command depends upon which platform you are compiling for - the cmake utility has the concept of generators, which
are capable of producing native build files for a number of systems - if you are on unix then the commandline will be<br />
<code>cmake -G "Unix Makefiles" .</code> which will create standard unix make files for use with the <code>make</code> command.</li>
<li>At this point the C API libraries can be compiled with <code>make</code> </li>
</ol>
<h2>Using the Api</h2>

<pre>

#include <stdio.h>
#include "arintf.h"

int main(int argc, char* argv[]) {
    init_ar();

    /* some examples.. */
    struct SesamePositionBean  result = cds_sesame_resolve("Crab");

    double ra = result.ra;
    double dec = result.dec;
    double size = 0.1;

    /* doing a cone search */
    char * ivorn = "ivo://wfau.roe.ac.uk/twomass-dsa/wsa";
    struct Resource_Base registry;
    /* TODO what about if the resource structure is some subclass - unions..  */
     registry = ivoa_registry_getResource(ivorn);

    JString query = ivoa_cone_constructQuery(ivorn, ra, dec, size);
    char * votable = ivoa_cone_executeVotable(query);


</pre>

<h3>C Api Documentation</h3>
<p>The detailed documentation of the various calls within the API is contained within the Java AR Javadoc. There are however some general rules that have been used to generate the C Api that the user should be aware of to make it easier to use the documentation</p>
<ul>
<li>Java beans have become C structs</li>
<li>Java bean hierarchies have been collapsed into a union of C structs. The union is named after the base of the java hierarchy with a _Base suffix. Each struct has a member <code>enum AcrType _type;</code> which can be used to acertain the type of the struct at runtime
<pre>
   struct Resource_Base {
   enum AcrType _type;
   union {
       struct Resource resource;

   struct Service service;
   struct CeaService ceaservice;
   struct TableService tableservice;
   struct StapService stapservice;
   struct SsapService ssapservice;
   struct SiapService siapservice;
   struct RegistryService registryservice;
   struct DataService dataservice;
   struct CatalogService catalogservice;
   struct ConeService coneservice;
   struct Application application;
   struct CeaApplication ceaapplication;
   struct DataCollection datacollection;
   struct TabularDB tabulardb;
   struct StandardSTC standardstc;
   struct Organisation organisation;
   struct Authority authority;
   } d;
};
</pre></li>
<li>Java Lists of particular types that are used in the API have a typedef ListOfxxx that defines a struct with a defintion
<pre>
typedef struct {
    int n;
    struct xxx *list; /* note that this is an array */        
   } ListOfxxx;

</pre>
</li>
</ul>
<p>Java beans have become C structs</p>

<h2>Generating a new API</h2>
<p>Note that this section only applies to developers of the C API itself - not users of the API</p>

<p>The C version of the AR API consists of a mixture of hand written code and code that is automatically generated from the Java definition
of the AR interface. When a new version of the AR is released the automatically generated code will need to be regenerated - this section describes how to do this.</p>
<p>The code is generated by using an XSL transformation of an intermediate product of the javadoc generation from the Java AR API - this produces a file called jel.xml, typically found in <code>target/jel/jel.xml</code> in that project. The steps involved in reproducing the 
</p>
<ol>
<li>Copy the <code>jel.xml</code> file into this directory</li>
<li>Run the genc.xsl stylesheet - note that the stylesheet is a version 2.0 stylesheet so an xml processor such as Saxon is recommended.  The command-line is<br />
<code>java -jar ~/.m2/repository/net/sf/saxon/saxon/8.7/saxon-8.7.jar -o arintf.h jel.xml genc.xsl<br /></code>
Note that it is important that the main output be named arintf.h - this is the definition of the C interface!</li>
</ol>
</body>
</html>