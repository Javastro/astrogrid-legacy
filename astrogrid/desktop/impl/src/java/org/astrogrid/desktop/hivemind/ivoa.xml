<?xml version="1.0"?>
<!DOCTYPE module  [
	<!ENTITY descriptors SYSTEM "classpath:/org/astrogrid/desktop/hivemind/ivoa-descriptors.xml">
	]>
<module id="ivoa" version="1.0.0" package="org.astrogrid.acr.ivoa">
	IVOA standard services.

	
	<contribution configuration-id="framework.descriptors">
		<acr-module name="ivoa" description="IVOA Standard Services">
		&descriptors;
		</acr-module>
	</contribution>	
		
	<contribution configuration-id="framework.acrServices">
			<acrService id="ssap" interface="Ssap" />
			<acrService id="siap" interface="Siap" />
			<acrService id="cone" interface="Cone" />
			<acrService id="skyNode" interface="SkyNode"/>
			<acrService id="adql074" interface="Adql074" />
			<acrService id="registry" interface="Registry" />
			<acrService id="externalRegistry" interface="ExternalRegistry" />
	</contribution>
	
	
	<contribution configuration-id="system.uiStructure" if="not (property ivoa.cache.disabled)">
		<action parentName="edit" name="cacheClear" text="Flush Cache"
			object="service:cache" methodName="flush" before="configreset" >
			<confirmMessage><![CDATA[<html>
				Remove all cached registry documents?
				Proceed?
			]]></confirmMessage>
		</action>		
	</contribution>		
	

	
	<!-- =====================
	REGISTRY
	-->
	
	<service-point id="registry" interface="org.astrogrid.desktop.modules.ivoa.RegistryInternal">
		System Registry
		<interceptor service-id="system.throbber" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.StreamingRegistryImpl" >
				<service>externalRegistry</service>
               <object>preference:org.astrogrid.registry.query.endpoint</object>
               <object>preference:org.astrogrid.registry.query.altendpoint</object>
				<service>ivoa.cache</service>				
			</construct>
		</invoke-factory>
	</service-point>
	
	<implementation service-id="registry" if="property ivoa.registry.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
	
		<contribution configuration-id="framework.preferences">
		<preference name="org.astrogrid.registry.query.endpoint" 
			advanced="true" requires-restart="true" propagate-to-config="true"
			default-value="http://galahad.star.le.ac.uk:8080/galahad-registry/services/RegistryQuery">
				<ui-name>Registry service endpoint</ui-name>
				<description>http url of the main registry service</description>
		</preference>
		<preference name="org.astrogrid.registry.query.altendpoint"
			advanced="true" requires-restart="true" propagate-to-config="true"		
			default-value="http://cass123.ast.cam.ac.uk/astrogrid-registry/services/RegistryQuery" >
				<ui-name>Registry service endpoint</ui-name>
				<description>http url of the main registry service</description>
		</preference>
	</contribution>
	<!-- =========================
	EXTERNAL REGISTRY
	 -->
	<service-point id="externalRegistry" interface="org.astrogrid.desktop.modules.ivoa.ExternalRegistryInternal">
		External Registries.
		<interceptor service-id="system.throbber" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.StreamingExternalRegistryImpl" >
				<string>${ivoa.registry.of.registries.endpoint}</string>
			</construct>
		</invoke-factory>	
	</service-point>
	
		<implementation service-id="externalRegistry" if="property ivoa.externalRegistry.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>
	

	
	<contribution configuration-id="hivemind.FactoryDefaults">
		<default symbol="ivoa.registry.of.registries.endpoint" value="http://FILL.ME.IN" />	
	</contribution>	
<!-- 
=========================
SSAP
 -->
	<service-point id="ssap" interface="Ssap">
		Simple Spectral Access Protocol
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SsapImpl" >
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>
		</invoke-factory>	
	</service-point>
	
	<implementation service-id="ssap" if="property ivoa.ssap.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>

<!-- 
==========================
SKYNODE
 -->			
		<service-point id="skyNode" interface="SkyNode">
			Skynode (unfinished)
		<interceptor service-id="system.throbber" />			
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SkyNodeImpl"/>
		</invoke-factory>			
	</service-point>
	
	<implementation service-id="skyNode" if="property ivoa.skynode.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>
<!-- 
====================
SIAP
 -->
	<service-point id="siap" interface="Siap">
		Simple Image Access Protocol
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SiapImpl">
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>			
		</invoke-factory>			
	</service-point>
	
	<implementation service-id="siap" if="property ivoa.siap.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
	<!-- 
	=====================
	CONE
	 -->
	<service-point id="cone" interface="Cone">
		Client to Cone Services
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.ConeImpl" >
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>
		</invoke-factory>	
	</service-point>

	<implementation service-id="cone" if="property ivoa.cone.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
	<!-- 
	============================
	DEPRECATED ADQL CONVERTOR
	
	TODO - add deprecation interceptor to this
	 -->
	<service-point id="adql074" interface="Adql074">
		ADQL convertor
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.Adql074DynamicImpl">
				<set property="endpoint" value="${ivoa.adql074.endpoint}" />
			</construct>
		</invoke-factory>			
	</service-point>
	
	<implementation service-id="adql074" if="property ivoa.adql074.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
		<!-- leaving this as-is - not upgrading to new system, as is deprecated -->
	<contribution configuration-id="hivemind.FactoryDefaults">
		<default symbol="ivoa.adql074.endpoint" value="http://openskyquery.net/AdqlTranslator/ADQLTrans.asmx"/>			
	</contribution>		
<!--  
=======================
RESULT CACHE 
-->
	<service-point id="cache" interface="org.astrogrid.desktop.modules.ivoa.CacheFactory">
	Result Cache. Would fit more logically in the system module, but then causes build
	problems for the hub. so it's better suited here - as it's used mostly in the ivoa.registry
	clients anyhow.
		<invoke-factory model="primitive">
			<construct class="org.astrogrid.desktop.modules.ivoa.CacheFactoryImpl">
				<string>${astrogrid.store.workdir}</string>
				<event-listener service-id="builtin.shutdown" />			
			</construct>
		</invoke-factory>
	</service-point>
	
		<implementation service-id="cache"  if="property ivoa.cache.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />					
	</implementation>			
	<!--  TODO - add more cache configuraiton options here -->
 </module>
 