<?xml version="1.0"?>
<!DOCTYPE module  [
	<!ENTITY descriptors SYSTEM "classpath:/org/astrogrid/desktop/hivemind/ivoa-descriptors.xml">
	]>
<module id="ivoa" version="1.0.0" package="org.astrogrid.acr.ivoa">
	IVOA standard services. 

	
	<contribution configuration-id="framework.descriptors">
		<acr-module name="ivoa" description="IVOA Standard Services">
		&descriptors;
		</acr-module>
	</contribution>	
		
	<contribution configuration-id="framework.acrServices">
			<acrService id="ssap" interface="Ssap" />
			<acrService id="siap" interface="Siap" />
			<acrService id="cone" interface="Cone" />
			<acrService id="skyNode" interface="SkyNode"/>
			<acrService id="adql" interface="Adql" />
			<acrService id="registry" interface="Registry" />
			<acrService id="externalRegistry" interface="ExternalRegistry" />
			<acrService id="cache" interface="CacheFactory" />
	</contribution>
	
	
	<!--  =====================
	ADQL
	 -->
	<service-point id="adql" interface="org.astrogrid.desktop.modules.ivoa.AdqlInternal">
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.AdqlImpl" />
		</invoke-factory>
	</service-point>
	
	<!-- =====================
	REGISTRY
	-->
	
	<service-point id="registry" interface="org.astrogrid.desktop.modules.ivoa.RegistryInternal">
		System Registry
        <interceptor service-id="system.edt" />        
		<interceptor service-id="system.throbber" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.StreamingRegistryImpl" >
				<service>externalRegistry</service>
               <object>preference:org.astrogrid.registry.query.endpoint</object>
               <object>preference:org.astrogrid.registry.query.altendpoint</object>
				<object>cache:resources</object>
				<object>cache:documents</object>
				<object>cache:bulk</object>				
			</construct>
		</invoke-factory>
	</service-point>
	
	<contribution configuration-id="ivoa.caches">
		cache for individual resource objects
		<cache name="resources"
			maxElementsInMemory="50"
			maxElementsOnDisk="300"
			overflowToDisk="true"
			diskPersistent="true"
			timeToLiveSeconds="${ivo.registry.cacheLife}"
			timeToIdleSeconds="345600"
		/>
		cache for registry return documents - resource docs, and xquery docs
		sized so it's just enough in memory one up, one down in registry google.
		<cache name="documents"
			maxElementsInMemory="3"
			maxElementsOnDisk="20"
			overflowToDisk="true"
			diskPersistent="true"
			timeToLiveSeconds="${ivo.registry.cacheLife}"
			timeToIdleSeconds="345600"
		/>
		cache for bulk searches, etc, of registry documents.
		smallest amount in memory, enough on disk to store astroscope queries.
		<cache name="bulk"
			maxElementsInMemory="1"
			maxElementsOnDisk="10"
			overflowToDisk="true"
			diskPersistent="true"
			timeToLiveSeconds="${ivo.registry.cacheLife}"
			timeToIdleSeconds="345600"
		/>			
	</contribution>
    
     <contribution configuration-id="util.selftest" >
        <object>service-property:registry:selftest</object>
    </contribution>
	
	<implementation service-id="registry" if="property ivoa.registry.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
	
		<contribution configuration-id="framework.preferences">
		<preference name="org.astrogrid.registry.query.endpoint" 
			advanced="false" requires-restart="true" propagate-to-config="true"
            default-value="http://registry.astrogrid.org/astrogrid-registry/services/RegistryQueryv1_0">
				<ui-name>Registry endpoint</ui-name>
				<description>http url of the main registry service</description>
                <alternative>http://alt.registry.astrogrid.org/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://msslxv.mssl.ucl.ac.uk:8080/mssl-registry/services/RegistryQueryv1_0</alternative>
				<alternative>http://harvesting-registry.roe.ac.uk/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://rakaposhi.star.le.ac.uk/astrogrid-registry/services/RegistryQueryv1_0</alternative>
   <!-- remove the following for public release -->
				<alternative>http://msslxt.mssl.ucl.ac.uk:8080/astrogrid-regtest-1_0/services/RegistryQueryv1_0</alternative>
                <alternative>http://twmbarlwm.star.le.ac.uk:8080/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://casx019-zone1.ast.cam.ac.uk:8080/astrogrid-registry/services/RegistryQuery</alternative>
				<units>url</units>
		</preference>
		<preference name="org.astrogrid.registry.query.altendpoint"
			advanced="false" requires-restart="true" propagate-to-config="true"		
            default-value="http://alt.registry.astrogrid.org/astrogrid-registry/services/RegistryQueryv1_0">
				<ui-name>Fallback Registry endpoint</ui-name>
				<description>http url of the main registry service</description>
                <alternative>http://registry.astrogrid.org/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://msslxv.mssl.ucl.ac.uk:8080/mssl-registry/services/RegistryQueryv1_0</alternative>
				<alternative>http://harvesting-registry.roe.ac.uk/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://rakaposhi.star.le.ac.uk/astrogrid-registry/services/RegistryQueryv1_0</alternative>
   <!-- remove the following for public release -->
                <alternative>http://msslxt.mssl.ucl.ac.uk:8080/astrogrid-regtest-1_0/services/RegistryQueryv1_0</alternative>
                <alternative>http://twmbarlwm.star.le.ac.uk:8080/astrogrid-registry/services/RegistryQueryv1_0</alternative>
                <alternative>http://casx019-zone1.ast.cam.ac.uk:8080/astrogrid-registry/services/RegistryQuery</alternative>
				<units>url</units>
		</preference>
		<preference name="ivo.registry.cacheLife" requires-restart="true"
			default-value="604800">
				<ui-name>Cached entries expire after</ui-name>
				<description>86400 seconds = a day, 604800 seconds = a week</description>
				<units>seconds</units>
		</preference>
	</contribution>
	<!-- =========================
	EXTERNAL REGISTRY
	 -->
	<service-point id="externalRegistry" interface="org.astrogrid.desktop.modules.ivoa.ExternalRegistryInternal">
		External Registries.
        <interceptor service-id="system.edt" />        
		<interceptor service-id="system.throbber" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.StreamingExternalRegistryImpl" >
                <service>registry</service>
                <service>adql</service>
			</construct>
		</invoke-factory>	
	</service-point>
	
		<implementation service-id="externalRegistry" if="property ivoa.externalRegistry.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>
	

	
	<contribution configuration-id="hivemind.FactoryDefaults">
		<default symbol="ivoa.registry.of.registries.endpoint" value="http://FILL.ME.IN" />	
	</contribution>	
<!-- 
=========================
SSAP
 -->
	<service-point id="ssap" interface="Ssap">
		Simple Spectral Access Protocol
        <interceptor service-id="system.edt" />        
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SsapImpl" >
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>
		</invoke-factory>	
	</service-point>
	
	<implementation service-id="ssap" if="property ivoa.ssap.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>

<!-- 
==========================
SKYNODE
 -->			
		<service-point id="skyNode" interface="SkyNode">
			Skynode (unfinished)
        <interceptor service-id="system.edt" />            
		<interceptor service-id="system.throbber" />			
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SkyNodeImpl"/>
		</invoke-factory>			
	</service-point>
	
	<implementation service-id="skyNode" if="property ivoa.skynode.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>
<!-- 
====================
SIAP
 -->
	<service-point id="siap" interface="Siap">
		Simple Image Access Protocol
        <interceptor service-id="system.edt" />        
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.SiapImpl">
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>			
		</invoke-factory>			
	</service-point>
	
	<implementation service-id="siap" if="property ivoa.siap.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	
	<!-- 
	=====================
	CONE
	 -->
	<service-point id="cone" interface="Cone">
		Client to Cone Services
        <interceptor service-id="system.edt" />        
		<interceptor service-id="system.throbber" />		
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ivoa.ConeImpl" >
				<service>ivoa.registry</service>
				<service>astrogrid.myspace</service>
			</construct>
		</invoke-factory>	
	</service-point>

	<implementation service-id="cone" if="property ivoa.cone.disabled">
		<invoke-factory service-id="hivemind.lib.PlaceholderFactory" />	
	</implementation>	

<!--  
=======================
RESULT CACHE 
-->
	<service-point id="cache" interface="org.astrogrid.acr.ivoa.CacheFactory">
	Result Cache. Would fit more logically in the system module, but then causes build
	problems for the hub. so it's better suited here - as it's used mostly in the ivoa.registry
	clients anyhow.
		<invoke-factory model="primitive">
			<construct class="org.astrogrid.desktop.modules.ivoa.CacheFactoryImpl">
				<string>${astrogrid.workdir}</string>
				<configuration>caches</configuration>
				<event-listener service-id="builtin.shutdown" />			
			</construct>
		</invoke-factory>
	</service-point>
	
	<contribution configuration-id="hivemind.ObjectProviders">
		<provider prefix="cache" service-id="cache" />
	</contribution>
		
	
	<configuration-point id="caches">
		Defines caches for components to use.
		<schema>
			<element name="cache" key-attribute="name">
				<attribute name="name" required="true" unique="true">
					name of the cache
				</attribute>
				<attribute name="diskPersistent" translator="boolean">
				For caches that overflow to disk, whether the disk cache persists between CacheManager instances.				
				</attribute>
				<attribute name="eternal" translator="boolean">
				 Sets whether elements are eternal.
				</attribute>
				<attribute name="maxElementsInMemory">
				the maximum objects to be held in the MemoryStore.
				</attribute>
				<attribute name="maxElementsOnDisk">
				  the maximum objects to be held in the DiskStore.
				</attribute>
				<attribute name="overflowToDisk" translator="boolean">
				whether elements can overflow to disk when the in-memory cache has reached the set limit.				
				</attribute>
				<attribute name="timeToIdleSeconds" >
				he time to idle for an element before it expires.
				</attribute>
				<attribute name="timeToLiveSeconds">
				 Sets the time to idle for an element before it expires.
				</attribute>
				<conversion class="net.sf.ehcache.config.CacheConfiguration" />
			</element>
		</schema>
	</configuration-point>
	
 </module>
 
