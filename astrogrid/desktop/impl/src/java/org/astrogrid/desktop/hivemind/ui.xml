<?xml version="1.0"?>
<!DOCTYPE module  [
	<!ENTITY descriptors SYSTEM "classpath:/org/astrogrid/desktop/hivemind/ui-descriptors.xml">
	
	]>
<module id="ui" version="1.0.0" package="org.astrogrid.acr.ui">
<!--  PREAMBLE -->
	<dependency module-id="system"/>
	<dependency module-id="framework" />
	<dependency module-id="astrogrid" />
	<dependency module-id="dialogs" />
	<dependency module-id="ivoa" />
	<dependency module-id="cds" />
	<dependency module-id="plastic" />				
			
	<contribution configuration-id="framework.descriptors">
		<acr-module name="ui" description="Applications for working with the VO">
		&descriptors;
		</acr-module>
	</contribution>	
		
	<contribution configuration-id="framework.acrServices">
			<acrService id="astroscope" interface="AstroScope"/>
			<acrService id="myspaceBrowser" interface="MyspaceBrowser" />
			<acrService id="registryBrowser" interface="RegistryBrowser" />
	</contribution>

	
<!--  
==============================
UI STRUCTURES
 -->

<!-- assume that if this module is loaded, we're running as workbench -->
	<contribution configuration-id="system.uiStructure">
			<action parentName="help" name="about" text="About VO Explorer.." onEventDispatchThread="true"
			object="instance:java.lang.String" methodName="concat" iconName="AGlogo16x16.png"
			after="*" > 
			<parameter><![CDATA[
			<html>
			<h1>VO Explorer v${astrogrid.desktop.version}</h1>		
			<b>http://www.astrogrid.org/desktop</b><br>
			<h2>Contributors</h2>
			<ul>
			 <li>Alasdair Allan</li>
			<li>Elizabeth Auden</li>
			<li>Kona Andrews</li>
			<li>Kevin Benson</li>
			<li>Silvia Dalla</li>
			<li>Gary Gilchrist</li>
			<li>Eduardo Gonzalez</li>
			<li>Norman Gray</li>
			<li>Paul Harrison</li>
			<li>Tony Linde</li>
			<li>Jeff Lusted</li>
			<li>Phil Nicholson</li>
			<li>Keith Noddle</li>
			<li>Jonathan Tedds</li>
			<li>Dave Morris</li>
			<li>Catherine Qin</li>
			<li>Anita Richards</li>
			<li>Guy Rixon</li>
			<li>John Taylor</li>
			<li>Mark Taylor</li>
			<li>Nicholas Walton</li>
			<li>Noel Winstanley</li>
			</ul>			
			<h2>Acknowledgements</h2>
			Contains code and/or integrates with services provided by CADC, CDS, ESA-VO, NVO, Starlink, Plastic, VOTech

			<hr>
			<h2>Build Information</h2>
			Built: ${astrogrid.build.date}<br>
			At: ${astrogrid.build.location}<br>
			With ${astrogrid.build.jdk}<br>
			By: ${astrogrid.build.by}
			</html>
			]]></parameter>
		</action>	
	</contribution>
	
	
<!--  
===============================
ASTROSCOPE
 -->
	<service-point id="astroscope" interface="org.astrogrid.desktop.modules.ui.AstroScopeInternal">
			<interceptor service-id="system.snitchInterceptor" />
		<invoke-factory> 
		<construct class="org.astrogrid.desktop.modules.ui.AstroScopeFactory" >
						<service>hiveutils.ObjectBuilder</service>
		</construct>
		</invoke-factory>	
	</service-point>

	<contribution configuration-id="system.windowFactories">
		<window name="All-VO Scope &#x003B2;">service:astroscope</window>
	</contribution>
							
	<contribution configuration-id="hiveutils.ObjectBuilderObjects">
		<object name="astroscope" class="org.astrogrid.desktop.modules.ui.AstroScopeLauncherImpl" >
		Describes how to build a new astroscope window.
			<inject object="service:system.ui"/>			
			<inject object="service:protocolsBuilder" />
			<inject object="service:actionsBuilder" />			
			<inject object="service-property:scopeHistory:list" />
			<inject object="object:scopeServiceList" />
			<inject object="service:system.vfs" />
			<inject object="service:cds.sesame" />
			<inject object="service:system.snitch" />
		</object>
		<object name="scopeServiceList" 
		class="org.astrogrid.desktop.modules.ui.scope.ScopeServicesList">
		Describes how to builld a subclass of registry google, specialized for
		displaying summaries in astroscope.
			<inject object="service:ivoa.registry" />
			<inject object="service:system.browser" />
			<inject object="service:ui.registryBrowser" />
			<inject object="cache:resources" />
			<inject object="cache:bulk" />
			<inject object="service:votech.vomon" />
			<inject object="preference:acr.advanced" />
		</object>
	</contribution>
	
	<service-point id="scopeHistory" visibility="private" interface="org.astrogrid.desktop.modules.ui.folders.FoldersProvider">
		Loads / saves the astroscope search history.
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.scope.ScopeHistoryProvider">
				<service>system.ui</service>
				<object>preference:astrogrid.workdir</object>
			</construct>
		</invoke-factory>
	</service-point>	
		
	<service-point id="protocolsBuilder" interface="org.astrogrid.desktop.hivemind.IterableObjectBuilder"
		visibility="private">
		Object builder for astroscope protocols
		<invoke-factory model="singleton">
			<construct class="org.astrogrid.desktop.hivemind.IterableObjectBuilderImpl">
				<log />
				<configuration>protocols</configuration>
				<service>hiveutils.ObjectTranslator</service>
				<service>hiveutils.EventLinker</service>
			</construct>
		</invoke-factory>
	</service-point>	
		
	<configuration-point id="protocols" schema-id="hiveutils.ObjectBuilderSchema">
		Configuration point for the list of 'protocols' - kinds of service that astroscope knows how to invoke.
		All should be an instance of DalProtocol
	</configuration-point>
		
	<!--  lists of protocols  -->
	<contribution configuration-id="protocols">
		<object name="siap" class="org.astrogrid.desktop.modules.ui.scope.SiapProtocol">
			<inject object="service:ivoa.registry" />
			<inject object="service:ivoa.siap" />
		</object>
		<object name="ssap" class="org.astrogrid.desktop.modules.ui.scope.SsapProtocol">
			<inject object="service:ivoa.registry" />
			<inject object="service:ivoa.ssap" />
		</object>
		<object name="cone" class="org.astrogrid.desktop.modules.ui.scope.ConeProtocol">
			<inject object="service:ivoa.registry" />
			<inject object="service:ivoa.cone" />
		</object>
		<object name="vizier" class="org.astrogrid.desktop.modules.ui.scope.AllVizierProtocol">
			<inject object="service:ivoa.cone" />
		</object>
		<object name="stap" class="org.astrogrid.desktop.modules.ui.scope.StapProtocol">
			<inject object="service:ivoa.registry" />
			<inject object="service:astrogrid.stap" />
		</object>		
	</contribution>

		<contribution configuration-id="system.helpmap">
		<item id="userInterface.astroscopeLauncher" url="http://www2.astrogrid.org/science/documentation/data-explore/astroscope" />
		<item id="astroscope.menu.science" url="http://www2.astrogrid.org/science/documentation/data-explore/astroscope" />
		<item id="astroscope.menu.reference" url="http://www2.astrogrid.org/science" />

	</contribution>

	<!-- -
	====================================
	SIMPLIFIED APP LAUNCHER
	 -->
	<service-point id="simpleApplicationLauncher" interface="org.astrogrid.desktop.modules.ui.TaskInvoker">
		<interceptor service-id="system.snitchInterceptor" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.SimplifiedAppLauncherFactory">
				<service>system.ui</service>
				<configuration>dialogs.regScopeToolEditors</configuration>
				<service>dialogs.resourceChooser</service>
				<service>astrogrid.applications</service>
				<service>astrogrid.myspace</service>
				<object>preference:acr.advanced</object>
<!--				<event-listener service-id="builtin.shutdown" />						-->
			</construct>
		</invoke-factory>	
	</service-point>


<!--  
===========================================
Stand-alone Query Builder
 -->
	<service-point id="queryBuilder" 
	interface="org.astrogrid.desktop.modules.adqlEditor.QueryBuilderInternal">
		<interceptor service-id="system.snitchInterceptor" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.adqlEditor.QueryBuilderFactory">
				<configuration>dialogs.regScopeQueryEditors</configuration>
				<service>dialogs.resourceChooser</service>
				<service>astrogrid.applications</service>
				<service>astrogrid.myspace</service>
				<service>system.ui</service>
				<object>preference:acr.advanced</object>
<!--				<event-listener service-id="builtin.shutdown" />						-->
			</construct>
		</invoke-factory>	
	</service-point>
	
		<contribution configuration-id="system.helpmap">
		<!-- TODO: fix these urls. -->
		<item id="userInterface.queryBuilder" url="http://www2.astrogrid.org/science/documentation/workbench-system-services/resources/resources/" />
		<item id="queryBuilder.menu.science" url="http://www2.astrogrid.org/science/documentation/workbench-system-services/resources/resources/" />
	</contribution>	
	
	<!-- 
	==================================
	VOEXPLORER
	 -->
	<service-point id="registryBrowser" interface="org.astrogrid.desktop.modules.ui.VOExplorerFactoryInternal">
			<interceptor service-id="system.snitchInterceptor" />
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.VOExplorerFactoryImpl" >
				<service>hiveutils.ObjectBuilder</service>
			</construct>
		</invoke-factory>	
	</service-point>
	
	<contribution configuration-id="system.windowFactories">
		<window name="VO Explorer">service:registryBrowser</window>
	</contribution>
	
	<contribution configuration-id="system.plasticMessageHandlers">
		<object>service:registryBrowser</object>
	</contribution>
	
	<contribution configuration-id="hiveutils.ObjectBuilderObjects">
		Describes how to build a new voexplorer window.
		<object name="voexplorer" class="org.astrogrid.desktop.modules.ui.voexplorer.VOExplorerImpl">
			<inject object="service:system.ui"/>
			<inject object="service:actionsBuilder" />
			<inject object="service:system.uiBuilder" />
			<inject object="service-property:resourceFolders:list" />
			<inject object="object:registryGooglePanel" />
			<inject object="service:querySize" /> 
		</object>
	</contribution>

	<service-point id="resourceFolders" visibility="private" interface="org.astrogrid.desktop.modules.ui.folders.FoldersProvider">
		Loads / saves the list of resource folders. shared between multiple instances of voexplorer.
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.folders.ResourceListsProvider">
				<service>system.ui</service>
				<object>preference:astrogrid.workdir</object>
			</construct>
		</invoke-factory>
	</service-point>

	<!--  makes the registryBrowser dsplay on startup. -->
	<contribution configuration-id="hivemind.EagerLoad">
		<load service-id="registryBrowser" />
	</contribution>

<!-- 
=====================================
FILE EXPLORER
 -->
 	<service-point id="fileExplorer" interface="org.astrogrid.desktop.modules.ui.FileExplorerFactoryInternal">
 		<interceptor service-id="system.snitchInterceptor" />
 		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.FileExplorerFactoryImpl" >
				<service>hiveutils.ObjectBuilder</service>
			</construct>
		</invoke-factory>	
 	</service-point>
 	
	<contribution configuration-id="system.windowFactories">
		<window name="File Explorer &#x003B1; ">service:fileExplorer</window>
	</contribution>
	
	<contribution configuration-id="system.plasticMessageHandlers">
		<object>service:fileExplorer</object>
	</contribution>	
	
	<contribution configuration-id="hiveutils.ObjectBuilderObjects">
		Describes how to build a new fileexplorer window.
		<object name="fileExplorer" class="org.astrogrid.desktop.modules.ui.fileexplorer.FileExplorerImpl">
			<inject object="service:system.ui"/>
			<inject object="service:actionsBuilder" />
			<inject object="service:system.uiBuilder" />
			<inject object="service-property:storageFolders:list" />
			<inject object="service:system.vfs" />
		</object>
	</contribution>

	<service-point id="storageFolders" visibility="private" interface="org.astrogrid.desktop.modules.ui.folders.FoldersProvider">
		Loads / saves the list of resource folders.
		<invoke-factory>
			<construct class="org.astrogrid.desktop.modules.ui.folders.StorageFoldersProvider">
				<service>system.ui</service>
				<object>preference:astrogrid.workdir</object>
			</construct>
		</invoke-factory>
	</service-point>

<!--  
********************************************
ACTIONS
-->
	
	<service-point id="actionsBuilder" interface="org.astrogrid.desktop.modules.system.ui.ActionContributionBuilder">
		Assembles actions menus from the contributed actions.
		<invoke-factory model="singleton">
			<construct class="org.astrogrid.desktop.modules.system.ui.ActionContributionBuilderImpl">
				<service>actionsFactory</service>
			</construct>
		</invoke-factory>
	</service-point>
	
	<service-point id="actionsFactory" interface="org.astrogrid.desktop.hivemind.IterableObjectBuilder"
		visibility="private">
		Object builder for actions
		<invoke-factory model="singleton">
			<construct class="org.astrogrid.desktop.hivemind.IterableObjectBuilderImpl">
				<log />
				<configuration>actions</configuration>
				<service>hiveutils.ObjectTranslator</service>
				<service>hiveutils.EventLinker</service>
			</construct>
		</invoke-factory>
	</service-point>	
		
	<configuration-point id="actions" schema-id="hiveutils.ObjectBuilderSchema">
		Configuration point for the list of 'invoke' tasks.
	</configuration-point>
		
	<!--  lists of Actions  -->
	<contribution configuration-id="actions">
		<object name="0queryscope" class="org.astrogrid.desktop.modules.ui.actions.QueryScopeActivity">
			<inject object="service:astroscope" />
			<inject name="section" object="literal:string:use" />
		</object>		
		<object name="0query" class="org.astrogrid.desktop.modules.ui.actions.BuildQueryActivity">
			<inject object="service:queryBuilder"/>
			<inject name="section" object="literal:string:use" />			
		</object>		
		<object name="0cea" class="org.astrogrid.desktop.modules.ui.actions.CeaActivity">
			<inject object="service:simpleApplicationLauncher"/>
			<inject name="section" object="literal:string:use" />			
		</object>
		<object name="1viewBrowser" class="org.astrogrid.desktop.modules.ui.actions.ViewInBrowserActivity">
			<inject object="service:system.browser"/>
			<inject name="section" object="literal:string:use" />
		</object>	
		<object name="1saveFile" class="org.astrogrid.desktop.modules.ui.actions.SaveActivity">
			<inject object="service:dialogs.resourceChooser" />
			<inject object="service:astrogrid.myspace" />
			<inject name="section" object="literal:string:use" />
		</object>		
		<object name="1web" class="org.astrogrid.desktop.modules.ui.actions.WebInterfaceActivity">
			<inject object="service:system.browser" />
			<inject name="section" object="literal:string:use" />			
		</object>	
		<object name="2plastic" class="org.astrogrid.desktop.modules.ui.actions.PlasticScavenger">
			<inject object="service:system.plasticList" />
			<inject object="service:system.tupperware" />
			<inject name="section" object="literal:string:plastic" />
		</object>
		<!-- seems to cause some kind of threading / race condition on linux.
		FIXME: find out what this is. 
		<object name="3script" class="org.astrogrid.desktop.modules.ui.actions.GenerateScriptScavenger">
			<inject object="service:dialogs.resourceChooser" />
			<inject object="service:astrogrid.myspace" />
			<inject name="section" object="literal:string:script" />		
		</object>
		-->
		<object name="0selection" class="org.astrogrid.desktop.modules.ui.actions.InfoActivity">
			<inject name="section" object="literal:string:info" />	
		</object>
		<object name="1further" class="org.astrogrid.desktop.modules.ui.actions.FurtherInfoActivity">
			<inject object="service:system.browser"/>
			<inject name="section" object="literal:string:info" />			
		</object>
		<object name="2contact" class="org.astrogrid.desktop.modules.ui.actions.ContactActivity">
			<inject object="service:system.browser"/>
			<inject name="section" object="literal:string:info" />			
		</object>	
		
		<object name="saveResource" class="org.astrogrid.desktop.modules.ui.actions.SaveResourceActivity" >
			<inject object="service:system.ui" />
			<inject object="service:dialogs.resourceChooser" />
			<inject object="service:ivoa.registry" />
			<inject object="service:astrogrid.myspace" />
			<inject name="section" object="literal:string:export" />			
		</object>
		<object name="saveIds" class="org.astrogrid.desktop.modules.ui.actions.SaveIdListActivity" >
			<inject object="service:dialogs.resourceChooser" />
			<inject object="service:astrogrid.myspace" />
			<inject name="section" object="literal:string:export" />			
		</object>
		<object name="saveXoXo" class="org.astrogrid.desktop.modules.ui.actions.SaveXoXoListActivity" >
			<inject object="service:dialogs.resourceChooser" />
			<inject object="service:astrogrid.myspace" />
			<inject name="section" object="literal:string:export" />			
		</object>	
		<!--  possibly - add 'broadcast' operations - see code in PlasticVotableActivity -->
	</contribution>
		
	<!--  help links -->
		<contribution configuration-id="system.helpmap">
		<item id="voexplorer.intro" url="http://wiki.astrogrid.org/pub/Astrogrid/VOExpDesignMeeting/registry-intro.pdf" />
		<item id="userInterface.voexplorer" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Overview" />
		<item id="voexplorer.hierarchies" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Folders"/>

		<item id="voexplorer.actions" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Actions"/>
		<item id="resourceActions.invoke" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Invoke_Actions" />
		<item id="resourceActions.info" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Info_Actions" />
		<item id="resourceActions.seeAlso" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#See_Also_Actions" />
		<item id="resourceActions.metadata" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Metadata_Actions" />
		
		<item id="resourceTask.astroscope" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Astroscope" />
		<item id="resourceTask.buildQuery" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#BuildQuery" />
		<item id="resourceTask.cea" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Invoke_Task"/>
		<item id="resourceTask.cone" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Catalogue_Search"/>
		<item id="resourceTask.script" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Generate_Script" />
		<item id="resourceTask.siap" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Image_Search" />		
		<item id="resourceTask.ssap" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Spectrum_Search"/>		
		<item id="resourceTask.web" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Open_Web_Interface"/>		
		
		<item id="resouceFolders" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Registry_View"/>
		<item id="resouceFolders.buttons" url="http://wiki.astrogrid.org/bin/view/Astrogrid/VoExplorer#Buttons" />
	</contribution>	
	

	
	<!--  =====================================
	Query size estimation
	 -->
	 <service-point id="querySize" visibility="private" interface="org.astrogrid.desktop.modules.ui.voexplorer.QuerySizer">
	 	Computes sizes of queries.
	 	<interceptor service-id="system.throbber" />
	 	<invoke-factory>
	 		<construct class="org.astrogrid.desktop.modules.ui.voexplorer.QuerySizerImpl">
	 			<service>ivoa.registry</service>
	 			<object>cache:querySizes</object>
	 		</construct>
	 	</invoke-factory>
	 </service-point>
	 
	 <contribution configuration-id="ivoa.caches">
	 	Cache for query sizes
	 	<cache name="querySizes"
	 		maxElementsInMemory="3"
	 		maxElementsOnDisk="300"
	 		overflowToDisk="true"
	 		diskPersistent="true"
	 		timeToLiveSeconds="${ivo.registry.cacheLife}"
	 		timeToIdleSeconds="${ivo.registry.cacheLife}"
	 		/>
	 	</contribution>

 </module>
 