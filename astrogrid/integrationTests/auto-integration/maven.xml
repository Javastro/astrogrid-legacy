<?xml version="1.0" ?>
<!-- $Id: maven.xml,v 1.120 2004/09/30 13:58:20 nw Exp $ -->
<!-- to use:
  check that tomcat is 'clean' and running - ie has no astrogrid components
  installed that will interfere with the deployment (use maven undeploy-all then
  manually check that it's worked).

   Run 'maven deploy-all'.  If it completes successfully, run 'maven int-test'.
   see also goal 'deploy-all-except-portal' - deploys backend components only

   The deployer checks the astrogrid repository and your local one as normal to find the latest wars to
   deploy, so if you have local changes to a component you will need to rebuild that component separately.
   When the auto builds happen, the astrogrid repository version will become 'newer' and you will need to
   rebuild your locally changed component.
   Alternatively, run this script with the -o switch which instructs maven to build offline
   -->

<!-- extension maven script -->
<project xmlns:j="jelly:core"
        xmlns:jsl="jelly:jsl"
        xmlns:jxml="jelly:xml"
        xmlns:maven="jelly:maven"
        xmlns:util="jelly:util"
        xmlns:deploy="deploy"
        xmlns:http="jelly:http"
                xmlns:define="jelly:define"
                xmlns:ag="org.astrogrid.deploy"
    default="jar:jar">

<j:import inherit="true" file="./mavendefinitions.xml"/>
<property environment="env"/>
        <!--use immutability in the next three lines...-->
<!-- this will not work on windows      <property name="tomcat.host" value="${env.HOSTNAME}"/> unix
        <property name="tomcat.host" value="${env.COMPUTERNAME}"/>  windows -->
    <property name="tomcat.host" value="localhost"/><!--default-->
<property name="tomcat.port" value="8080"/>
<property name="tomcat.url" value="http://${tomcat.host}:${tomcat.port}"/>
<property name="tomcat.manager.url" value="${tomcat.url}/manager"/>
<property name="existurl" value="${tomcat.url}/exist/servlet/db"/>
<!--+
    | need to rationalize the use of the astrogrid.iteration - pah
    | better name would be astrogrid.release - i.e. it is intended to be SNAPSHOT for the current iteration and the iteration TAG for preious ones
    +-->
        <j:if test="${empty(context.getVariable('astrogrid.iteration'))}">
                <j:set var="astrogrid.iteration" value="SNAPSHOT"/>
        </j:if>
<property name="astrogrid.release" value="${astrogrid.iteration}"/>
<!--+
    | Please avoid using 'version' it is already set by the Java VM.
<property name="version" value="${astrogrid.iteration}"/>
    +-->
<!-- name of the smtp mail server to use -->
<property name="mailhost" value="localhost" />
<!-- where the root to the registry services is -->
<property name="registry.endpoint" value="${tomcat.url}/astrogrid-registry-${astrogrid.iteration}/services/Registry"/>
<!-- other, non-configurable properties -->

<!-- temp dir - used for mangling files, etc -->
<property name="temporary.dir" location="${basedir}/tmp" />
<property name="config.webapp.name" value="astrogrid-autoconfiguration" />

        <j:if test="${empty(context.getVariable('registry.authorityid'))}">
                <j:set var="registry.authorityid" value="org.astrogrid.localhost"/>
        </j:if>
        <property name="communityid" value="${registry.authorityid}" /> <!--NB in general it is *not* true that community=authority this is a temporary measure to start the refactoring of the code-->
        <!-- tokens to subst into config files -->
        <filter token="WORKDIR" value="${work.dir}" />
        <filter token="CONFIGPATH" value="${tomcat.url}/${config.webapp.name}" />
        <filter token="TOMCATROOT" value="${tomcat.url}" />
        <filter token="TOMCATLOC" value="${tomcat.location}" />
        <filter token="REGAUTHORITY" value="${registry.authorityid}" />
                <filter token="COMMUNITYID" value="${communityid}" />

        <filter token="TOMCATPORT" value="${tomcat.port}"/>
        <filter token="VERSION" value="${astrogrid.iteration}"/>
        <filter token="MAILHOST" value="${mailhost}" />
        <filter token="TOOLBASEDIR" value="${work.dir}/cea/commandline/work/"/> <!--this is the directory that is the root of CEA command line applications set it to the workdir for autointegration purposes-->
        <filter token="CENTRALREGISTRY" value="${registry.endpoint}"/>
        <filter token="TOMCATUSER" value="${tomcat.manager.username}"/>
        <filter token="TOMCATPASS" value="${tomcat.manager.password}"/>

<!-- setup -->
<goal name="astrogrid-clean" prereqs="clean:clean">
       <delete dir="${temporary.dir}" />
</goal>


<goal name="init" prereqs="declare-tasks">
                <echo>AuthorityID used: ${registry.authorityid}</echo>
                                <echo>Community ivo identifier: ${communityid}</echo>
<!--do not delete the temporary directory here - pah-->
        <mkdir dir="${temporary.dir}" />
        <deploy:copy-deps todir="${temporary.dir}" />
<!-- important to do this before the original gets patched -->
                <copy file="${temporary.dir}/pal-${pom.currentVersion}.war"
                      tofile="${temporary.dir}/pal-fits-${pom.currentVersion}.war" />

                <copy file="${temporary.dir}/pal-${pom.currentVersion}.war"
                      tofile="${temporary.dir}/pal-sec-${pom.currentVersion}.war" />
                <copy file="${temporary.dir}/pal-${pom.currentVersion}.war"
                              tofile="${temporary.dir}/pal-cds-${pom.currentVersion}.war" />
</goal>

<!-- main goals //////////////////////////////////////////////////////////////////////////////////// -->
<goal name="cycle"
 description="deprecated: timing issues. call undeploy-all, deploy-all, setup, int-test by hand.">
         <echo>Deprecated: problems with timing / memory load. call undeploy-all, deploy-all, int-test by hand individually</echo>
        <attainGoal name="undeploy-all" />
        <attainGoal name="deploy-all" />
        <attainGoal name="int-test" />
</goal>

<goal name="deploy-all" prereqs="init">
                <echo>*** Deploying all webapps...</echo>
        <attainGoal name="common-libs-deploy" />
        <attainGoal name="configuration-deploy" />
        <sleep seconds="2" />
        <attainGoal name="reg-deploy" />
        <sleep seconds="4" />
        <attainGoal name="jes-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-server-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-commandline-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-http-deploy" />
        <sleep seconds="2" />
        <attainGoal name="myspace-deploy" />
        <sleep seconds="2" />
        <attainGoal name="filestore-deploy" />
        <sleep seconds="2" />
        <attainGoal name="pal-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-fits-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-sec-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-cds-deploy" />
        <sleep seconds="2" />
        <attainGoal name="community-deploy"/>
        <sleep seconds="2" />
        <attainGoal name="portal-deploy" />
        <sleep seconds="4" />
        <attainGoal name="setup" />
</goal>
<goal name="deploy-all-except-portal" prereqs="init" description="deploy all webapps except the portal, setup environment.">
        <echo>*** Deploying all webapps except the portal...</echo>
        <attainGoal name="common-libs-deploy" />
        <attainGoal name="configuration-deploy" />
        <sleep seconds="2" />
        <attainGoal name="reg-deploy" />
        <sleep seconds="4" />
        <attainGoal name="jes-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-server-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-commandline-deploy" />
        <sleep seconds="2" />
        <attainGoal name="cea-http-deploy" />
        <sleep seconds="2" />
        <attainGoal name="myspace-deploy" />
        <sleep seconds="2" />
        <attainGoal name="filestore-deploy" />
        <sleep seconds="2" />
        <attainGoal name="pal-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-fits-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-sec-deploy" />
        <sleep seconds="4" />
        <attainGoal name="pal-cds-deploy" />
        <sleep seconds="2" />
        <attainGoal name="community-deploy"/>
        <sleep seconds="2" />
        <attainGoal name="setup" />
</goal>

<goal name="undeploy-all" prereqs="init" description="undeploy all webapps">
        <echo>*** Undeploying all webapps...</echo>
        <attainGoal name="configuration-undeploy"/>
        <attainGoal name="jes-undeploy" />
        <attainGoal name="cea-server-undeploy" />
        <attainGoal name="cea-commandline-undeploy" />
        <attainGoal name="cea-http-undeploy" />
        <attainGoal name="reg-undeploy" />
        <attainGoal name="myspace-undeploy" />
        <attainGoal name="filestore-undeploy" />
        <attainGoal name="pal-undeploy" />
        <attainGoal name="pal-fits-undeploy" />
        <attainGoal name="pal-sec-undeploy" />
        <attainGoal name="pal-cds-undeploy" />
        <attainGoal name="community-undeploy" />
        <attainGoal name="portal-undeploy" />
</goal>

<goal name="undeploy-all-except-portal" prereqs="init" description="undeploy all webapps except the portal">
        <echo>*** Undeploying all webapps except the portal...</echo>
        <attainGoal name="configuration-undeploy"/>
        <attainGoal name="jes-undeploy" />
        <attainGoal name="cea-server-undeploy" />
        <attainGoal name="cea-commandline-undeploy" />
        <attainGoal name="cea-http-undeploy" />
        <attainGoal name="reg-undeploy" />
        <attainGoal name="myspace-undeploy" />
        <attainGoal name="filestore-undeploy" />
        <attainGoal name="pal-undeploy" />
        <attainGoal name="pal-fits-undeploy" />
        <attainGoal name="pal-sec-undeploy" />
        <attainGoal name="pal-cds-undeploy" />
        <attainGoal name="community-undeploy" />
</goal>

<goal name="list" prereqs="init" description="list deployed webapps">
        <tomcat-list url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" />
</goal>


<goal name="int-test" description="run integration tests">
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="test" />
</goal>

<goal name="eclipse-int-test" description="Generate eclipse files for the tests">
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="eclipse" />
</goal>

<goal name="astrogrid-build-site" description="Build the site docs for the test project">
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="site" />
</goal>

<goal name="astrogrid-deploy-site" description="Deploy the site docs for the test project" >
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="site:deploy" />
</goal>
<!--+
    | This pregoal takes any simple html docs in the xdocs folder and turns them into xdoc xml,
    | before they are turned back into maven-style html docs.  Why?  html is easier to write in
    | a WYSIWIG editor than xdoc xml
    |
    | I think using this means that the  documents all turn out in the same maven style (plus navigation bars, etc)
    +-->
<preGoal name="xdoc:jelly-transform">
    <attainGoal name="html2xdoc"/>
</preGoal>

<goal name="ui-int-test"  description="run integration tests in ui runner">
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="test:ui" />
</goal>

<goal name="scripting-gui"  description="run javascript gui">
        <maven:maven descriptor="${basedir}/tests-project.xml" goals="run-scripting-gui" />
</goal>

<goal name="style-workflows" description="apply presentation stylesheet to all workflows">
                  <!--declare the transformer factory to use -->
        ${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}
        <xslt style="${basedir}/build/workflow.xsl" destdir="${work.dir}/styled-workflows" basedir="${work.dir}/jes" />
</goal>

<!-- Working direcotry //////////////////////////////////////////////////////////////////////////////////////////////// -->

<goal name="setup" description="configure webapps and working dir">
        <echo>*** Configuring...</echo>
        <attainGoal name="community-toolkit"/>
        <attainGoal name="setup-working-dir" />
        <attainGoal name="setup-exist" />
        <attainGoal name="setup-registry" />
        <attainGoal name="setup-community"/>
        <attainGoal name="setup-cea-server" />
        <attainGoal name="setup-cea-commandline" />
        <attainGoal name="setup-cea-http" />
        <attainGoal name="setup-myspace" />
        <attainGoal name="setup-filestore" />
        <attainGoal name="copy-test-resources" />
</goal>

<goal name="setup-working-dir" description="create working dir, copy across templates">
        <echo>Setting up working directory</echo>
                <!-- do not delete the working dir here -->
        <mkdir dir="${work.dir}" />
        <copy todir="${work.dir}" overwrite="false" filtering="true">
            <fileset dir="work">
                <exclude name="**/filestore/data/*"/>
            </fileset>
        </copy>
        <!-- make everything world-accessible - necessary as tomcat may be running as different user to
        whoever is executing this script

        hmm - dunno if this is necessary really.
         -->
        <chmod file="${work.dir}" perm="a+rwx" type="dir"/>
        <chmod dir="${work.dir}" perm="a+rwx" type="dir">
                <include name="**/*" />
        </chmod>
        <chmod dir="${work.dir}" perm="a+rw" type="file">
                <include name="**/*" />
        </chmod>
</goal>

<goal name="setup-cea-server">
        <mkdir dir="${work.dir}/cea/java/store" />
</goal>

<goal name="setup-cea-http">
        <mkdir dir="${work.dir}/cea/http/store" />
</goal>

<goal name="setup-cea-commandline" description="setup specific to commandline cea server">
        <mkdir dir="${work.dir}/cea/commandline/store" />
        <chmod dir="${work.dir}/cea/commandline/work" perm="a+x">
                <include name="*.sh" />
        </chmod>
</goal>

<goal name="setup-myspace" description="myspace setup">
    <echo>Configuring Myspace</echo>
</goal>

<goal name="setup-filestore" description="filestore setup">
    <echo>Configuring test data and repository for filestore one ....</echo>
    <mkdir dir="${work.dir}/filestore-one/repository"/>
    <mkdir dir="${work.dir}/filestore-one/data"/>
    <copy todir="${work.dir}/filestore-one/data">
        <fileset dir="work/filestore/data"/>
    </copy>
    <echo>Configuring test data and repository for filestore two ....</echo>
    <mkdir dir="${work.dir}/filestore-two/repository"/>
    <mkdir dir="${work.dir}/filestore-two/data"/>
    <copy todir="${work.dir}/filestore-two/data">
        <fileset dir="work/filestore/data"/>
    </copy>
</goal>

<goal name="setup-community" description="Community setup">
    <echo>Configuring community database ....</echo>
    <attainGoal name="community-database"/>
    <attainGoal name="community-register"/>
</goal>

<goal name="setup-exist" description="PUT documents in eXist">
         <echo>Configuring eXist entries</echo>
                <delete dir="${temporary.dir}/exist-entries" />
        <copy todir="${temporary.dir}/exist-entries" filtering="true">
                <fileset dir="exist-entries">
                        <include name="**/*.xml" />
                </fileset>
        </copy>
        <!-- now upload each one -->
        <pathconvert property="entries" pathsep=" ">
                <path>
                        <fileset dir="${temporary.dir}/exist-entries"/>
            </path>
        </pathconvert>
        <util:tokenize var="entryList" delim=" ">${entries}</util:tokenize>
        <j:expr value="${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}"/>
                <j:set var="collpath" value="${temporary.dir}/exist-entries"/>
        <j:forEach var="entry" items="${entryList}">
          <echo>${entry}</echo>

                        <util:file name="${entry}"  var="xmlentry" />
                        <jxml:parse xml="${xmlentry}" var="xmlbody" />

                        <echo>${existurl}/${entry.substring(collpath.length())}</echo>
                        <j:set var="existtempurl" value="${existurl}${entry.substring(collpath.length())}"/>
                    <util:replace oldChar="\" newChar="/" var="existputurl">${existtempurl}</util:replace>
                    <echo>${existputurl}</echo>
                <http:put var="xmlexist" uri="${existputurl}">
                <header name="Content-Type" value="text/xml"/>
                <http:body>
                                        <jxml:copyOf select="$xmlbody" />
                </http:body>
                        </http:put>
                <echo>${xmlexist.statusCode}</echo>

        </j:forEach>
        <echo>Finsihed setting up eXist</echo>

</goal>

<goal name="setup-registry" description="populate the registry" >
        <echo>Configuring Registry</echo>
        <!-- expand tokens -->
        <copy todir="${temporary.dir}/registry-entries" filtering="true">
                <fileset dir="registry-entries">
                        <include name="**/*.xml" />
                </fileset>
        </copy>
        <!-- now upload each one -->
        <pathconvert property="entriesr" pathsep=" ">
                <path>
                        <fileset dir="${temporary.dir}/registry-entries"/>
                </path>
        </pathconvert>
            <util:tokenize var="entryListr" delim=" ">${entriesr}</util:tokenize>

            <j:expr value="${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}"/>
                        <ag:register file="${temporary.dir}/registry-entries/ARegistry.xml" />

                <waitfor maxwait="10" maxwaitunit="second" checkevery="500">
                <http url="${tomcat.url}/exist/xmldb/db/?xpath=%2F%2F*%3AResource%5B*%3AIdentifier%2F*%3AResourceKey%2Ftext%28%29+%3D+%27org.astrogrid.registry.RegistryService%27%5D"/>
                </waitfor>

        <j:forEach var="entryr" items="${entryListr}">

            <j:expr value="${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}"/>
                        <ag:register file="${entryr}" />
<!--            <ant target="register" antfile="register.xml" >
        `       <property name="registry.entry" value="${entryr}"/>
            </ant>
                        -->

        </j:forEach>
</goal>

<!--+
    | Unpack our Community install toolkit.
    +-->
<goal name="community-toolkit">
    <echo message=""/>
    <echo message="Installing community toolkit ...."/>
    <!--+
        | Create our toolkit directory.
        +-->
    <mkdir dir="${temporary.dir}/community"/>
    <mkdir dir="${temporary.dir}/community/toolkit"/>
    <!--+
        | Unpack our toolkit.
        +-->
    <unzip src="${temporary.dir}/astrogrid-community-install-${astrogrid.iteration}.zip" dest="${temporary.dir}/community/toolkit"/>
    <!--+
        | Set the community ident.
        +-->
    <propertyfile
        file="${temporary.dir}/community/toolkit/install.properties">
        <entry key="org.astrogrid.community.ident"
            value="${registry.authorityid}"/>
    </propertyfile>
    <!--+
        | Set the registry endpoint.
        +-->
    <propertyfile
        file="${temporary.dir}/community/toolkit/install.properties">
        <entry key="org.astrogrid.registry.url"
            value="${registry.endpoint}"/>
    </propertyfile>
    <!--+
        | Set the registry admin endpoint.
        +-->
    <propertyfile
        file="${temporary.dir}/community/toolkit/install.properties">
        <entry key="org.astrogrid.registry.admin"
            value="${registry.endpoint}Update"/>
    </propertyfile>
    <!--+
        | Set the local hostname.
        +-->
    <propertyfile
        file="${temporary.dir}/community/toolkit/install.properties">
        <entry key="service.host"
            value="${tomcat.host}"/>
    </propertyfile>
</goal>

<!--+
    | Initialise our Community database.
    +-->
<goal name="community-database">
    <echo message=""/>
    <echo message="Installing community database ...."/>
    <!--+
        | Wait for our service to respond.
        +-->
    <attainGoal name="community-wait"/>
    <!--+
        | Reset our database tables.
        +-->
    <ant
        target="database.reset"
        dir="${temporary.dir}/community/toolkit"
        antfile="${temporary.dir}/community/toolkit/install.xml"
        />
    <!--+
        | Load our database tables.
        +-->
    <ant
        target="database.load"
        dir="${temporary.dir}/community/toolkit"
        antfile="${temporary.dir}/community/toolkit/install.xml"
        >
                <!-- load the community from a file local to the autointegration rather than out of the community install kit -->
                <property name="community.xmlfile" value="file:///${work.dir}/community/demoaccounts.xml"/>
                </ant>
</goal>

<!--+
    | Register the Community.
    +-->
<goal name="community-register">
    <echo message=""/>
    <echo message="Registering community service ...."/>
    <j:expr value="${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}"/>
    <echo message=""/>
    <!--+
        | Wait for our service to respond.
        +-->
    <attainGoal name="community-wait"/>
    <!--+
        | Register our service(s).
        +-->
    <ant target="service.register"
         dir="${temporary.dir}/community/toolkit"
         antfile="${temporary.dir}/community/toolkit/install.xml"
         />
</goal>
<!--+
    | Wait for the Community service to respond.
    +-->
<goal name="community-wait">
    <echo message="Waiting for Community webapp .."/>
    <echo message="  URL : ${tomcat.url}/astrogrid-community/happyaxis.jsp"/>
    <waitfor maxwait="10" maxwaitunit="second" checkevery="500">
        <http url="${tomcat.url}/astrogrid-community"/>
    </waitfor>
</goal>

<!--+
    | Upload a Registry Entry to the local service.
    +-->
<goal name="registry.upload.test">
    <echo message="Uploading Registry Entry .."/>
    <j:expr value="${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}"/>
    <echo message=""/>
    <ant target="register"
         antfile="register.xml"
         >
        <property name="registry.entry" value="tmp/community/config/service/policy.manager.xml"/>
    </ant>
</goal>

<!-- pregoals ///////////////////////////////////////////////////////////////////////////////////////////////// -->

  <preGoal name="java:compile">
     <mkdir dir="${basedir}/target/classes" />     <!-- Clover fails if this dir is not present -->
  </preGoal>

  <preGoal name="test:test-resources">
        <attainGoal name="copy-test-resources" />
  </preGoal>

  <goal name="copy-test-resources" description="takes a copy of the config, puts it on the classpath for the test classes to find">
          <echo>Copying global config file across to the client / test code</echo>
          <copy file="webapps/astrogrid-configuration/AstroGridConfig.properties" tofile="test/java/astrogrid.properties" filtering="true" overwrite="true" />
  </goal>


<goal name="run-scripting-gui" description="don't call directly - use scripting-gui goal">
        <mkdir dir="${temporary.dir}/client" />
        <copy todir="${temporary.dir}/client" filtering="true">
                <fileset dir="webapps/astrogrid-configuration" />
        </copy>
        <!-- classname="org.mozilla.javascript.tools.shell.Main" for command-line version -->
        <java classname="org.mozilla.javascript.tools.debugger.Main"
                fork="true" classpathref="maven.dependency.classpath"
                dir="${temporary.dir}/client">
        </java>
</goal>




<!-- deployment //////////////////////////////////////////////////////////////////////// -->

<goal name="common-libs-deploy" description="copy db drivers, etc into shared directory">
        <echo message="Tomcat common : ${tomcat.common.lib.dir}"/>
        <copy verbose="true" todir="${tomcat.common.lib.dir}">
                <fileset dir="${temporary.dir}">
                        <include name="hsql*.jar" />
                        <include name="mail*.jar" />
                        <include name="activation*.jar" /> <!-- required by mail - dunno why tomcat doesn't ship with these.. -->
                </fileset>
        </copy>
</goal>

<!-- hand assembled webapps ///////////////////////////////////////-->
<goal name="configuration-deploy" description="create and install configuration webapp" >
        <copy todir="${temporary.dir}/astrogrid-configuration" filtering="true">
                <fileset dir="webapps/astrogrid-configuration" />
        </copy>
        <jar destfile="${temporary.dir}/${config.webapp.name}.war" basedir="${temporary.dir}/astrogrid-configuration">
        </jar>

                <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                        path="/${config.webapp.name}" war="file:///${temporary.dir}/${config.webapp.name}.war" />

</goal>

<!-- context- driven webapps ////////////////////////////////-->
<goal name="jes-deploy">
        <copy todir="${temporary.dir}/jes" filtering="true">
                <fileset dir="contexts/jes" />
        </copy>
       <ag:maybe-enable-cougaar webapp="jes" />
        <war update="true" destfile="${temporary.dir}/astrogrid-jes-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/jes"/>
        </war>
  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-jes-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-jes-${pom.currentVersion}.war"/>
</goal>

<goal name="cea-server-deploy"   >
        <copy todir="${temporary.dir}/cea-server" filtering="true">
                <fileset dir="contexts/cea-server" />
        </copy>
       <ag:maybe-enable-cougaar webapp="cea-server" />
        <war update="true" destfile="${temporary.dir}/astrogrid-cea-server-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/cea-server"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-server-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-cea-server-${pom.currentVersion}.war"/>

</goal>

<goal name="cea-commandline-deploy"   >
        <copy todir="${temporary.dir}/cea-commandline" filtering="true">
                <fileset dir="contexts/cea-commandline" />
        </copy>
       <ag:maybe-enable-cougaar webapp="cea-commandline" />
        <war update="true" destfile="${temporary.dir}/astrogrid-cea-commandline-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/cea-commandline"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-commandline-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-cea-commandline-${pom.currentVersion}.war"/>

</goal>

<goal name="cea-http-deploy" >
        <copy todir="${temporary.dir}/cea-http" filtering="true">
                <fileset dir="contexts/cea-http" />
        </copy>
       <ag:maybe-enable-cougaar webapp="cea-http" />
        <war update="true" destfile="${temporary.dir}/astrogrid-cea-http-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/cea-http"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-http-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-cea-http-${pom.currentVersion}.war"/>

</goal>


<goal name="reg-deploy" >
                <!--
        <copy todir="${temporary.dir}/registry" filtering="true">
                <fileset dir="contexts/registry" />
        </copy>
        <war update="true" destfile="${temporary.dir}/astrogrid-registry-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/registry"/>
        </war>
                -->
        <copy todir="${temporary.dir}/registry" filtering="true" overwrite="true">
            <fileset dir="webapps/astrogrid-configuration/registry">
                <include name="astro*.prop*"/>
            </fileset>
    </copy>
    <ag:maybe-enable-cougaar webapp="registry" />

    <war update="true" destfile="${temporary.dir}/astrogrid-registry-${pom.currentVersion}.war">
                <classes dir="${temporary.dir}/registry"/>
    </war>

          <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-registry-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-registry-${pom.currentVersion}.war"/>


          <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
     path="/exist" war="file:///${temporary.dir}/exist-SNAPSHOT.war"/>

</goal>

<goal name="myspace-deploy" >
        <copy todir="${temporary.dir}/myspace" filtering="true">
                <fileset dir="contexts/myspace" />
        </copy>
        <ag:maybe-enable-cougaar webapp="myspace" />
        <war update="true" destfile="${temporary.dir}/astrogrid-mySpace-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/myspace"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-mySpace-${pom.currentVersion}" war="file:///${temporary.dir}/astrogrid-mySpace-${pom.currentVersion}.war"/>

</goal>

<goal name="filestore-deploy">
    <!--+
        | Deploy filestore one.
        +-->
    <j:set var="filestore.name" value="filestore-one"/>
    <attainGoal name="filestore-deploy-sub"/>
    <!--+
        | Deploy filestore two.
        +-->
    <j:set var="filestore.name" value="filestore-two"/>
    <attainGoal name="filestore-deploy-sub"/>
</goal>

<goal name="filestore-deploy-sub">
    <echo>Deploying ${filestore.name} ....</echo>
    <!--+
        | Setup the params.
        +-->
    <j:set var="filestore.webapp"    value="astrogrid-${filestore.name}-${pom.currentVersion}"/>
    <filter token="FILESTORE_NAME"   value="${filestore.name}"/>
    <filter token="FILESTORE_WEBAPP" value="${filestore.webapp}"/>
    <!--+
        | Make a copy of the war file.
        +-->
    <copy filtering="false"
        file="${temporary.dir}/astrogrid-filestore-${pom.currentVersion}.war"
        toFile="${temporary.dir}/${filestore.webapp}.war"
        />
    <!--+
        | Copy the context file.
        +-->
    <copy todir="${temporary.dir}/${filestore.name}" filtering="true">
        <fileset dir="contexts/filestore"/>
    </copy>
    <ag:maybe-enable-cougaar webapp="${filestore.name}" />
    <!--+
        | Update the war file.
        +-->
    <war update="true" destfile="${temporary.dir}/${filestore.webapp}.war">
        <metainf dir="${temporary.dir}/${filestore.name}"/>
    </war>
    <!--+
        | Deploy the war file into Tomcat.
        +-->
    <tomcat-deploy
        update="true"
        url="${tomcat.manager.url}"
        username="${tomcat.manager.username}"
        password="${tomcat.manager.password}"
        path="/${filestore.webapp}"
        war="file:///${temporary.dir}/${filestore.webapp}.war"
        />
</goal>

<goal name="pal-deploy" >
        <copy todir="${temporary.dir}/pal" filtering="true">
                <fileset dir="contexts/pal" />
        </copy>
       <ag:maybe-enable-cougaar webapp="pal" />
        <war update="true" destfile="${temporary.dir}/pal-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/pal"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-${pom.currentVersion}" war="file:///${temporary.dir}/pal-${pom.currentVersion}.war"/>

</goal>

<!-- NOEL - cougaar taglib won't work with these pal wars - pal uses a different naming pattern. arse -->
<goal name="pal-fits-deploy" >
                <copy file="${temporary.dir}/pal-${pom.currentVersion}.war"
                      tofile="${temporary.dir}/pal-fits-${pom.currentVersion}.war" />
        <copy todir="${temporary.dir}/pal_fits" filtering="true">
                <fileset dir="contexts/pal_fits" />
        </copy>
       <ag:maybe-enable-cougaar webapp="pal_fits" />
        <war update="true" destfile="${temporary.dir}/pal-fits-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/pal_fits"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-fits-${pom.currentVersion}" war="file:///${temporary.dir}/pal-fits-${pom.currentVersion}.war"/>

</goal>

<goal name="pal-sec-deploy" >
        <copy todir="${temporary.dir}/pal_sec" filtering="true">
                <fileset dir="contexts/pal_sec" />
        </copy>
       <ag:maybe-enable-cougaar webapp="pal-sec" />
        <war update="true" destfile="${temporary.dir}/pal-sec-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/pal_sec"/>
        </war>

  <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-sec-${pom.currentVersion}" war="file:///${temporary.dir}/pal-sec-${pom.currentVersion}.war"/>

</goal>

        <goal name="pal-cds-deploy" >

                <copy todir="${temporary.dir}/pal_cds" filtering="true">
                        <fileset dir="contexts/pal_cds" />
                </copy>
                <ag:maybe-enable-cougaar webapp="pal_cds" />
                <war update="true" destfile="${temporary.dir}/pal-cds-${pom.currentVersion}.war">
                        <metainf dir="${temporary.dir}/pal_cds"/>
                </war>

          <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                  path="/astrogrid-pal-cds-${pom.currentVersion}" war="file:///${temporary.dir}/pal-cds-${pom.currentVersion}.war"/>

        </goal>


<goal name="portal-deploy">
        <copy todir="${temporary.dir}/portal" filtering="true">
                <fileset dir="contexts/portal" />
        </copy>
       <ag:maybe-enable-cougaar webapp="portal" />
        <war update="true" destfile="${temporary.dir}/astrogrid-portal-${pom.currentVersion}.war">
                <metainf dir="${temporary.dir}/portal" />
        </war>

        <tomcat-deploy update="true" url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                path="/astrogrid-portal" war="file:///${temporary.dir}/astrogrid-portal-${pom.currentVersion}.war" />

</goal>


<goal name="community-deploy">
    <copy todir="${temporary.dir}/community/webapp" filtering="true">
        <fileset dir="contexts/community" />
    </copy>
       <ag:maybe-enable-cougaar webapp="community" />
    <war update="true" destfile="${temporary.dir}/astrogrid-community-${pom.currentVersion}.war">
        <metainf dir="${temporary.dir}/community/webapp"/>
    </war>
    <tomcat-deploy
        update="true"
        url="${tomcat.manager.url}"
        username="${tomcat.manager.username}"
        password="${tomcat.manager.password}"
        path="/astrogrid-community-${pom.currentVersion}"
        war="file:///${temporary.dir}/astrogrid-community-${pom.currentVersion}.war"
        />
</goal>

<!-- undeploy ///////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
<goal name="reg-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-registry-${pom.currentVersion}" />


  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/exist" />

</goal>

<goal name="myspace-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-mySpace-${pom.currentVersion}" />

</goal>

<goal name="filestore-undeploy" >
    <!--+
        | Deploy filestore one.
        +-->
    <j:set var="filestore.name" value="filestore-one"/>
    <attainGoal name="filestore-undeploy-sub"/>
    <!--+
        | Deploy filestore two.
        +-->
    <j:set var="filestore.name" value="filestore-two"/>
    <attainGoal name="filestore-undeploy-sub"/>
</goal>

<goal name="filestore-undeploy-sub" >
    <echo>UnDeploying ${filestore.name} ....</echo>
    <!--+
        | Setup the params.
        +-->
    <j:set var="filestore.webapp"    value="astrogrid-${filestore.name}-${pom.currentVersion}"/>
    <!--+
        | Undeploy the webapp.
        +-->
    <tomcat-remove
        url="${tomcat.manager.url}"
        username="${tomcat.manager.username}"
        password="${tomcat.manager.password}"
        path="/${filestore.webapp}"
        />
</goal>

<goal name="cea-server-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-server-${pom.currentVersion}" />

</goal>
<goal name="cea-commandline-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-commandline-${pom.currentVersion}" />

</goal>
<goal name="cea-http-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-cea-http-${pom.currentVersion}" />

</goal>
<goal name="jes-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-jes-${pom.currentVersion}" />

</goal>


<goal name="pal-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-${pom.currentVersion}" />

</goal>

<goal name="pal-fits-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-fits-${pom.currentVersion}" />

</goal>

<goal name="pal-sec-undeploy" >

  <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
          path="/astrogrid-pal-sec-${pom.currentVersion}" />

</goal>

<goal name="pal-cds-undeploy" >

          <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                  path="/astrogrid-pal-cds-${pom.currentVersion}" />

</goal>

<goal name="configuration-undeploy" >

        <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                path="/astrogrid-autoconfiguration" />

</goal>

<goal name="portal-undeploy">

        <tomcat-remove url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}"
                path="/astrogrid-portal" />

</goal>

<goal name="community-undeploy" >

    <tomcat-remove
        url="${tomcat.manager.url}"
        username="${tomcat.manager.username}"
        password="${tomcat.manager.password}"
        path="/astrogrid-community-${pom.currentVersion}" />

</goal>

<goal name="CLEANTOMCAT" description="run this to clean out tomcat directories if tomcat not running - will clean the tmp and working directories">
        <delete includeEmptyDirs="true" defaultexcludes="false" >
                <fileset dir="${tomcat.location}/webapps" >
                        <include name="astrogrid-*/**"/>
                        <include name="exist*/**"/>
           </fileset>
                <fileset dir="${tomcat.location}/work/Catalina/localhost" >
                        <include name="*/**"/>
           </fileset>
                <fileset dir="${tomcat.location}/conf/Catalina/localhost" >
                        <include name="astrogrid-*.xml"/>
           </fileset>
                <fileset dir="${tomcat.location}/logs" >
                        <include name="*"/>
           </fileset>
        </delete>
                <!-- clean the temp dir here as well -->
                <delete dir="${temporary.dir}" />
                                <delete dir="${work.dir}"/>
</goal>



<!-- extra reports - full junit report, annotated with regression info.-->
<postGoal name="maven-junit-report-plugin:report">
        <attainGoal name="full-junit-report" />
        <attainGoal name="produce-baseline-summary" />
        <attainGoal name="annotate-report" />
        <attainGoal name="style-full-report" />
</postGoal>
<goal name="full-junit-report">
        <mkdir dir="${basedir}/target/docs/junit-full" />
       ${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}
        <junitreport todir="${basedir}/target">
                <fileset dir="${basedir}/target/test-reports">
                        <include name="TEST-*.xml" />
                </fileset>
        </junitreport>
</goal>

<goal name="style-full-report">
       ${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}
        <style basedir="${basedir}/target/" destdir="${basedir}/target/docs/junit-full" style="${basedir}/build/junit-frames.xsl">
                <include name="TESTS-TestSuites-Annotated.xml" />
                <param name="output.dir" expression="${basedir}/target/docs/junit-full" />
        </style>

      <!-- now the workflow documents-->

      <style basedir="${basedir}/target/docs/junit-full" destdir="${basedir}/target/docs/junit-full"
        style="${basedir}/build/workflow.xsl">
                <include name="**/*-workflow.xml" />
        </style>


</goal>


<goal name="produce-baseline-summary" description="generate summary test report, which could be used as a baseline for future tests">
       ${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}
       <!-- define summarizing stylesheet inline - handy!-->
        <jsl:stylesheet var="summarize" >
                <jsl:template match="/">
                        <testsuites>
                        <baseline-summary>
                                <baseline-name>GeneratedSummary</baseline-name>
                                <baseline-description>to fill in</baseline-description>
                                <j:new var="now" className="java.util.Date" />
                                <when>${now}</when>
                                <j:invokeStatic var="where" className="java.net.InetAddress" method="getLocalHost" />
                                <where>${where}</where>
                                <j:invokeStatic var="who" className="java.lang.System" method="getProperty">
                                        <j:arg value="user.name" />
                                </j:invokeStatic>
                                <who>${who}</who>
                                <project-name>auto-integration</project-name>
                                <project-version>${pom.currentVersion}</project-version>
                                <total-tests><jxml:expr select="sum(//testsuite/@tests)" /></total-tests>
                                <total-errors><jxml:expr select="sum(//testsuite/@errors) + sum(//testsuite/@failures)"/></total-errors>
                        </baseline-summary>
                        <jsl:applyTemplates select="//testsuite" />
                        </testsuites>
                </jsl:template>

                <jsl:template match="testsuite">
                        <jxml:element name="testsuite">
                              <jxml:attribute name="name"><jxml:expr select="@name"/></jxml:attribute>
                             <jxml:attribute name="package"><jxml:expr select="@package"/></jxml:attribute>
                             <jxml:attribute name="tests"><jxml:expr select="@tests"/></jxml:attribute>
                             <jxml:attribute name="failures"><jxml:expr select="@failures + @errors"/></jxml:attribute>
                             <jsl:applyTemplates select="testcase" />
                        </jxml:element>
                </jsl:template>

                <jsl:template match="testcase">
                        <jxml:element name="testcase">
                                <jxml:attribute name="name"><jxml:expr select="@name" /></jxml:attribute>
                                <jxml:attribute name="failure"><jxml:expr select="count(failure) + count(error)" /></jxml:attribute>
                        </jxml:element>
                </jsl:template>
        </jsl:stylesheet>
        <echo>Producing summary from current test results</echo>
        <!-- read in input file -->
        <jxml:parse var="allSuites" xml="target/TESTS-TestSuites.xml"/>
        <!-- apply stylesheet -->
        <j:file name="${basedir}/target/regression-baseline-summary.xml"><!-- add date here -->
         <jsl:style stylesheet="${summarize}" select="$allSuites" />
        </j:file>
</goal>

<goal name="annotate-report" description="add details from saved baseines into current test results">
        <echo>annotating test report with previous baselines</echo>
        <!-- take a copy to start -->
        <copy file="${basedir}/target/TESTS-TestSuites.xml" tofile="${basedir}/target/TESTS-TestSuites-Annotated.xml" overwrite="true"/>
        <fileScanner var="files">
                <fileset dir="${basedir}/baselines">
                        <include name="*.xml" />
                </fileset>
        </fileScanner>
        <j:new var="now" className="java.util.Date" />
        <j:forEach var="baselineFile" items="${files.iterator()}">
                <echo>Merging baseline ${baselineFile}</echo>
                <!-- parse this document in -->
                <!-- read in baseline file -->
                <jxml:parse var="baseline" xml="${baselineFile}" />

                <j:set var="baselineName"><jxml:expr select="$baseline/testsuites/baseline-summary/baseline-name" /></j:set>
                <echo>Baseline '${baselineName}' defined in ${baselineFile}</echo>
                <!-- define stylesheet -->
                <jsl:stylesheet var="annotate">
                        <jsl:template match="testsuites">
                                  <jxml:element name="testsuites">
                                        <jxml:attribute name="date">${now}</jxml:attribute>
                                        <jxml:copyOf select="$baseline/testsuites/baseline-summary" />
                                        <jsl:applyTemplates select="testsuite|baseline-summary"/>
                                </jxml:element>
                        </jsl:template>
                        <jsl:template match="testsuite">
                                <jxml:copy select=".">
                                        <jxml:set var="currentSuite" select="." />
                                        <jxml:set var="suiteSummary" select="$baseline/testsuites/testsuite[@package=$currentSuite/@package][@name=$currentSuite/@name]" />
                                        <!-- work around for bug- necessary to have two [..] clauses, as 'and' doesn't seem to work within a clause -->
                                          <jxml:element name="baseline">
                                                <jxml:attribute name="name">${baselineName}</jxml:attribute>
                                                <jxml:attribute name="tests"><jxml:expr select="$suiteSummary/@tests"/></jxml:attribute>
                                                <jxml:attribute name="failures"><jxml:expr select="$suiteSummary/@failures"/></jxml:attribute>
                                          </jxml:element>
                                        <jsl:applyTemplates select="testcase|baseline|properties|system-err|system-out"/>
                                </jxml:copy>
                        </jsl:template>
                        <jsl:template match="testcase">
                                <jxml:copy select=".">
                                        <jxml:set var="currentTest" select="." />
                                        <jxml:set var="testSummary" select="$suiteSummary/testcase[@name=$currentTest/@name]"/>
                                        <jxml:element name="baseline">
                                                <jxml:attribute name="name">${baselineName}</jxml:attribute>
                                                <jxml:attribute name="failure"><jxml:expr select="$testSummary/@failure"/></jxml:attribute>
                                        </jxml:element>
                                        <jsl:applyTemplates select="error|failure|baseline"/>
                                </jxml:copy>
                        </jsl:template>

                        <jsl:template match="properties|error|failure|baseline|baseline-summary"><!-- pass through.. -->
                                <jxml:copyOf select="." />
                        </jsl:template>
                        <jsl:template match="system-err"><!-- need special handling to preserve markup -->
                                <system-err><jxml:expr select="." /></system-err>
                        </jsl:template>
                        <jsl:template match="system-out"><!-- need special handling to preserve markup -->
                                <system-out><jxml:expr select="." /></system-out>
                        </jsl:template>
                </jsl:stylesheet>
                <!-- read in intput file -->
                <jxml:parse var="allSuites" xml="target/TESTS-TestSuites-Annotated.xml" />
                <!-- apply stylesheet -->
                <j:file name="${basedir}/target/processed-TESTS-TestSuites-Annotated.xml">
                        <jsl:style stylesheet="${annotate}" select="$allSuites" />
                </j:file>
                <!-- move new file back to original copy -->
                <move file="${basedir}/target/processed-TESTS-TestSuites-Annotated.xml"
                        tofile="${basedir}/target/TESTS-TestSuites-Annotated.xml" overwrite="true"/>
        </j:forEach>
</goal>

<!-- boilerplate below here /////////////////////////////////////////////////////////////////////////////////////////////-->

  <goal name="axis-declare-tasks">
     <taskdef resource="axis-tasks.properties"  classpathref="maven.dependency.classpath" />
  </goal>

<!-- tomcat tools -->

    <goal name="frog">
        <!--+
            | Clean out the target directory.
            +-->
        <attainGoal name="clean:clean"/>
        <delete dir="${temporary.dir}"/>
        <!--+
            | Initialise the integration env.
            +-->
        <attainGoal name="init"/>
        <!--+
            | Deploy our components.
            +-->
        <attainGoal name="common-libs-deploy"/>
        <attainGoal name="configuration-deploy"/>
        <attainGoal name="reg-deploy"/>
        <attainGoal name="myspace-deploy"/>
        <attainGoal name="filestore-deploy"/>
        <attainGoal name="community-deploy"/>
        <!--+
            | Configure our components.
            +-->
        <attainGoal name="community-toolkit"/>
        <attainGoal name="setup-working-dir"/>
        <attainGoal name="setup-registry"/>
        <attainGoal name="setup-filestore"/>
        <attainGoal name="setup-myspace"/>
        <attainGoal name="community-database"/>
        <attainGoal name="community-register"/>
        <!--+
            | Run the integration tests.
            +-->
        <attainGoal name="int-test"/>
    </goal>

    <goal name="toad">
        <!--+
            | Clean out the target directory.
            +-->
        <attainGoal name="clean:clean"/>
        <delete dir="${temporary.dir}"/>
        <!--+
            | Initialise the integration env.
            +-->
        <attainGoal name="init"/>
        <!--+
            | Deploy our components.
            +-->
        <attainGoal name="deploy-all"/>
        <!--+
            | Run the integration tests.
        <attainGoal name="int-test"/>
        <attainGoal name="astrogrid-build-site"/>
            +-->
        <attainGoal name="astrogrid-build-site"/>
    </goal>
</project>
