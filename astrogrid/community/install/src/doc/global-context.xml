<?xml version="1.0" encoding="ISO-8859-1" ?>
<document>
    <properties>
        <title>Global context</title>
    </properties>
    <body>
        <section name="Global context">
            <p>
                One way to configure the JNDI properties is to add them to the <code>GlobalNamingResources</code> element in the Tomcat <code>server.xml</code> configuration file.
            </p>
            <subsection name="Global element">
                <p>
                    The <code>GlobalNamingResources</code> element configures properties and resources that are available to all WebApps within the Tomcat server.
                </p>
                <p>
                    The <code>GlobalNamingResources</code> element is located close to the the top of the Tomcat configuration file.
<source><![CDATA[
<Server .... >
    <!-- Global JNDI resources -->
    <GlobalNamingResources>
        ...
    </GlobalNamingResources>
    ...
</Server>
]]></source>
                </p>
            </subsection>
            <subsection name="Config location">
                <p>
                    The <code>Environment</code> entry for the Community configuration file can be placed in the <code>GlobalNamingResources</code> element.
<source><![CDATA[
<Server .... >
    <!-- Global JNDI resources -->
    <GlobalNamingResources>
        <!--+
            | The Community config file location.
            +-->
        <Environment
            name="org.astrogrid.community.config"
            type="java.lang.String"
            value="/etc/astrogrid/astrogrid-community-config.xml"/>
        ...
    </GlobalNamingResources>
    ...
</Server>
]]></source>
                </p>
            </subsection>
            <subsection name="Database resource">
                <p>
                    The Community database <code>Resource</code> element can be placed in the <code>GlobalNamingResources</code> element.
<source><![CDATA[
<Server .... >
    <!-- Global JNDI resources -->
    <GlobalNamingResources>
        ...
        <!--+
            | The Community database resource.
            +-->
        <Resource
            name="jdbc/org.astrogrid.community.database"
            type="javax.sql.DataSource"
            auth="Container"/>
        ...
    </GlobalNamingResources>
    ...
</Server>
]]></source>
                </p>
            </subsection>
            <subsection name="Database properties">
                <p>
                    The Community database properties can be placed in the <code>GlobalNamingResources</code> element.
<source><![CDATA[
<Server .... >
    <!-- Global JNDI resources -->
    <GlobalNamingResources>
        ...
        <!--+
            | The Community database properties.
            +-->
        <ResourceParams
            name="jdbc/org.astrogrid.community.database">
            <parameter>
                <name>url</name>
                <value>jdbc:hsqldb:/var/astrogrid/org.astrogrid.community</value>
            </parameter>
            ...
        </ResourceParams>
        ...
    </GlobalNamingResources>
    ...
</Server>
]]></source>
                </p>
            </subsection>
            <subsection name="Local Context">
                <p>
                    Although the resources in the <code>GlobalNamingResources</code> element are visible to all the WebApps within the Tomcat server,
                    each WebApp needs to have a reference to the the resources defined in its own local <code>Context</code> element.
                </p>
                <p>
                    In order to include the resource references, the Community WebApp needs a <code>Context</code> element added to the Tomcat configuration file.
<source><![CDATA[
<Server .... >
    ...
    <Service name="Tomcat-Standalone">
        ...
        <Engine name="Standalone" .... >
            ...
            <Host name="localhost" .... >
                ...
                <!--+
                    | Configure a local context for our WebApp.
                    +-->
                <Context path="/astrogrid-community" docBase="astrogrid-community.war">
                    ...
                </Context>
            </Host>
        </Engine>
    </Service>
</Server>
]]></source>
                </p>
                <subsection name="Context path">
                    <p>
                        The path attribute of the <code>Context</code> element configures the external URL path for the WebApp.
                        <br/>
                        Setting the <code>path</code> to <code>/astrogrid-community</code> will set the external URL for resources within the WebApp to the following.
<source><![CDATA[
http://localhost/astrogrid-community/....
]]></source>
                    </p>
                </subsection>
                <subsection name="Context docBase">
                    <p>
                        The <code>docBase</code> attribute of the Context element configures the location Tomcat will use to load the WebApp.
                        <p style="font-size:x-small;font-style:italic">
                            <img style="float:left;margin-right:5px" src="images/note.gif"/>
                            Note that setting this to point to a war file will mean that Tomcat will not unpack the war file.
                            <br/>
                            Tomcat will serve the WebApp content directly from the war file without unpacking it.
                        </p>
                    </p>
                </subsection>
                <subsection name="Resource links">
                    <p>
                        In order to access the global resources, the WebApp needs to have reference links defined in its <code>Context</code> for each of the global resources it needs to access.
<source><![CDATA[
<Server .... >
    ...
    <!-- Global JNDI resources -->
    <GlobalNamingResources>
        <!--+
            | The Community config file location.
            +-->
        <Environment
            name="org.astrogrid.community.config"
            type="java.lang.String"
            value="/etc/astrogrid/astrogrid-community-config.xml"/>
        ...
        <!--+
            | The Community database resource.
            +-->
        <Resource
            name="jdbc/org.astrogrid.community.database"
            type="javax.sql.DataSource"
            auth="Container"/>
        ...
    </GlobalNamingResources>
    ...
    <Service name="Tomcat-Standalone">
        ...
        <Engine name="Standalone" .... >
            ...
            <Host name="localhost" .... >
                ...
                <!--+
                    | Configure a local context for our WebApp.
                    +-->
                <Context path="/astrogrid-community" docBase="astrogrid-community.war">
                    <!--+
                        | Reference to the global Environment property.
                        +-->
                    <ResourceLink
                        name="org.astrogrid.community.config"
                        type="java.lang.String"
                        global="org.astrogrid.community.config"/>
                    <!--+
                        | Reference to the global database Resource.
                        +-->
                    <ResourceLink
                        name="jdbc/org.astrogrid.community.database"
                        type="javax.sql.DataSource"
                        global="jdbc/org.astrogrid.community.database"/>
                </Context>
            </Host>
        </Engine>
    </Service>
</Server>
]]></source>
                    </p>
                </subsection>
            </subsection>
        </section>
    </body>
</document>
