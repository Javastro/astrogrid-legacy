<project name="astrogrid-openjms" basedir="." default="build">
  <target name="init">
    <property name="openjms.home" value="${basedir}/test"/>
    
    <property name="openjms.src.dir" value="${basedir}/files"/>
    <property name="openjms.dst.dir" value="${openjms.home}"/>
    <property name="openjms.tmp.dir" value="${basedir}/tmp"/>
    
    <property name="openjms.jdbc.database" value="openjmsantdb"/>
    <property name="openjms.jdbc.url" value="jdbc:postgresql://localhost/${openjms.jdbc.database}"/>
    <property name="openjms.jdbc.user" value="openjmsantuser"/>
    <property name="openjms.jdbc.password" value="jmspass"/>

    <property name="openjms.setenv.sh" value="bin/setenv.sh"/>

    <property name="openjms.database.sql" value="${openjms.dst.dir}/config/create_postgresql.sql"/>

    <property name="postgres.jdbc.url" value="jdbc:postgresql://localhost"/>
    <property name="postgres.jdbc.user" value="postgres"/>
    <property name="postgres.jdbc.password" value=""/>
    <property name="postgres.jdbc.driver" value="org.postgresql.Driver"/>
    <property name="postgres.jdbc.classpath" value="${openjms.dst.dir}/lib/pg73b1jdbc3.jar"/>

    <property name="postgres.openjms.src" value="create-database-and-user.sql"/>
    <property name="postgres.openjms.sql" value="${openjms.dst.dir}/${postgres.openjms.src}"/>

    <property name="postgres.conf.src" value="new_pg_hba.conf"/>
    <property name="postgres.conf" value="${openjms.dst.dir}/${postgres.conf.src}"/>

    <property name="postgres.ip.address" value="127.0.0.1"/>
    <property name="postgres.ip.mask" value="255.0.0.0"/>
  </target>
  
  <target name="install" depends="init">
    <mkdir dir="${openjms.home}"/>
    <mkdir dir="${openjms.dst.dir}"/>
    <mkdir dir="${openjms.tmp.dir}"/>
    
    <echo message="postgres sql file: ${postgres.openjms.sql}"/>

    <copy todir="${openjms.dst.dir}">
      <fileset dir="${openjms.src.dir}">
        <exclude name="config/openjms.xml"/>
        <exclude name="${postgres.openjms.src}"/>
        <exclude name="${postgres.conf.src}"/>
        <exclude name="${openjms.setenv.sh}"/>
      </fileset>
    </copy>

    <copy todir="${openjms.dst.dir}">
      <fileset dir="${openjms.src.dir}">
        <include name="config/openjms.xml"/>
        <include name="${postgres.openjms.src}"/>
        <include name="${postgres.conf.src}"/>
        <include name="${openjms.setenv.sh}"/>
      </fileset>
      
      <filterset>
        <filter token="OPENJMS.HOME" value="${openjms.dst.dir}"/>
        <filter token="OPENJMS.JDBC.URL" value="${openjms.jdbc.url}"/>
        <filter token="OPENJMS.JDBC.USER" value="${openjms.jdbc.user}"/>
        <filter token="OPENJMS.JDBC.PASSWORD" value="${openjms.jdbc.password}"/>
        <filter token="OPENJMS.JDBC.DATABASE" value="${openjms.jdbc.database}"/>
        <filter token="OPENJMS.JDBC.DRIVER" value="${postgres.jdbc.driver}"/>
        <filter token="IP.ADDRESS" value="${postgres.ip.address}"/>
        <filter token="IP.MASK" value="${postgres.ip.mask}"/>
      </filterset>
    </copy>
    
    <chmod dir="${openjms.dst.dir}/bin" perm="ugo+rx" includes="*.sh"/>
    
    <sql driver="${postgres.jdbc.driver}"
         url="${postgres.jdbc.url}"
         userid="${postgres.jdbc.user}"
         password="${postgres.jdbc.password}"
         src="${postgres.openjms.sql}"
         classpath="${postgres.jdbc.classpath}"
         autocommit="true"
         onerror="continue"/>
    
    <sql driver="${postgres.jdbc.driver}"
         url="${openjms.jdbc.url}"
         userid="${openjms.jdbc.user}"
         password="${openjms.jdbc.password}"
         src="${openjms.database.sql}"
         classpath="${postgres.jdbc.classpath}"
         autocommit="true"
         onerror="continue"/>
    
    <echo message=""/>
    <echo message="***"/>
    <echo message="***MANUAL STEP***"/>
    <echo message="- check ${postgres.conf} and alter if necessary"/>
    <echo message="- append ${postgres.conf} to PostgreSQL pg_hba.conf"/>
    <echo message="- run pg_ctl reload as PostgreSQL superuser"/>
    <echo message="***MANUAL STEP***"/>
    <echo message="***"/>
    <echo message=""/>
  </target>
</project>
