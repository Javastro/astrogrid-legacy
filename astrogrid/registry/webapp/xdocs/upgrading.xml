<?xml version="1.0" encoding="ISO-8859-1" ?>
<document>
    <properties>
        <title>AstroGrid registry upgrading</title>
    </properties>
    <body>
    <section name="Switching to 1.0 VOResources">
      <p>
		 If your registry is still mainly focused on 0.10 then you should switch to 1.0 as soon as possible.  The
		 registry supports both Resource versions. At the current moment though 1.0 is used everywhere in Astrogrid
		 and only a very few clients 'may' still call the 0.10.  The registry handles the 1.0 Resources in a separate table
		 so you will need to self register again <a href="../admin/selfRegisterForm.jsp">here</a> <strong>Note as of mid 2008 most registries have already been upgraded and
		 self registered, but might not have upgraded other components</strong>.  Various 
		 components have been upgraded such as CEA, Community, VOSpace, DAL so these would need to be upgraded and go through
		 the various steps of submitting it into the Registry.<br />
      </p>
      <p>
      	 Some administrators sometimes keep old property files if you are getting a warning on your index page saying you are not on
      	 1.0 version then go your your 'Edit Properties' <a href='../admin/environment-main.jsp'>here</a> to change the property reg.custom.query.defaultContractVersion to be 1.0
      </p>
   </section>    
    <section name="Upgrading">
      <p>
         <strong><font color='red'>If your registry was installed before October 15 2006 then you must read the next section below 'Upgrading embedded eXist when binaries change' before you do any upgrade.</font></strong>         
         <ul>
            <li>First go into your Tomcat Manager.</li>
            <li>Find your registry context and click on "undeploy".  This should delete the war file and the directory.
               <i>*If it doesn't then shutdown tomcat and delete it war file and directory, then start tomcat back up.</i>
            </li>
            <li>Now deploy the new war file via tomcat manager or by simply dropping in the war file into the webapps directory (if using tomcat).</li>
            <li>Now set the enviornment entries like you had before, typically only two or three properties is all that is changed.  This can be done by changing the web.xml or using Tomcat Administration GUI.  See 'Configure' page if you need to remember how to change properties and which properties to change.</li>
         </ul>       
		<strong>
          By default registry uses an xml database known as eXist embedded into its webapp and data is stored in the webapp.  
          If you have not done so already it is RECOMMENDED to read the <a href='exist_reference.html'>eXist Reference Guide</a> 
          on how to move the data out or at least know where the data is stored for coping back over if needed when your using the embedded eXist.  
          </strong>         
      </p>
   </section>
	<section name="Upgrading embedded eXist when binaries change">
	  <p>
		Not often but at times eXist binaries are changed because improvements are made in the database.  When this happens the
		current embedded binaries will not work after the upgrade so a backup of the actual xml contents of the database are needed then after the upgrade to restore.
		<br />
		There are several options you can choose and listed here are the various ways.
		<br />Option 1:<br />
		<ul>
		   <li><i>Should note that Option 2 is probably the fastest and easiest.</i></li>
		   <li>If you have a new registry after October 15 2006 then you have the luxury of doing backup and restores via the
		   eXist webstart GUI or web dav.  See <a href='../dbclients.jsp'>DB Client</a></li>
		   <li>With the Client GUI or Web Dav you can easily make a backup and then after you do your upgrade you can do a restore.</li>
		</ul>
        <br />Option 2 (Before Oct 15 2006):<br />
        <ul>
			<li>Go ahead and follow the normal "Upgrading" section above and upgrade your registry to the newer version.
            </li>
			<li>Since there is not a huge amount of astrogrid registries, a zip file has been made of the majority of registries plus a full registry. 
                Go to: <a href='http://www.astrogrid.org/maven/org.astrogrid/zips'>Zips</a>
			</li>
			<li>There you will find a version of eXist ready to use for embedding into your registry based around 'your' registry.
                It takes the form of xmldb_exist-{version}-{main reg authority}.zip ex: xmdb_exist-1.2-rvo.zip
			</li>
			<li>
				<i>If you run a full registry then xmldb_exist-2006.4-full.zip</i>
			</li>
			<li>
				Now simply unzip this file over your other embedded eXist directory, restart your registry webapp.  And enverything is set.
			</li>
		</ul>
		<br />Option 3:<br />
		<ul>
			<li>The other option is to do a backup and restore of your xml files.  Check if you have a backupandresource.{sh/bat} in your tomcat/webapps/{registry}/WEB-INF directory if not then this is quite an old registry and may require a few more commands, but is detailed below.</li>
			<li>If your data directory is outside your webapp: Copy your tomcat/webapps/{registry}/WEB-INF/lib directory to the same location as your conf.xml.  So you should have:
				conf.xml, "data" directory, and "lib" directory previous instructions missed the note about lib directory needing to be copied.
			</li>
			<li>Create a backup directory on your system.</li>
			<li>set a EXIST_HOME variable to the directory location of your conf.xml.</li>
			<li>Now look the directions of how to do a backup of your data it is the located at the top of your backupandrestore.{sh/bat}			</li>
			<li>
			    If you don't have a backupandresoure.{sh/bat}
				Run this command from your WEB-INF directory:<br />
				Windows:<br />
				"java -Djava.endorsed.dirs=\lib -Dexist.home={directory of conf.xml} -jar start.jar backup -d {backupdirectory} -u admin -b /db  -ouri=xmldb:exist://"
				<br />Unix:<br />
				"java -Djava.endorsed.dirs=/lib -Dexist.home={directory of conf.xml} -jar start.jar backup -d {backupdirectory} -u admin -b /db  -ouri=xmldb:exist://"				
			</li>
			<li>
			   Go through the normal upgrading steps and you will again need to move your embedded eXist data to a directory.
			</li>
			<li>
				Now that you have the new registry installed a restore is needed.
			</li>
			<li>
				You can either do the webstartable GUI detailed here <a href="../dbclients.jsp">here</a>
			</li>
			<li>
				Or run the restore part of the backupandrestore.{sh/bat}.<br />
				Go to your tomcat/webapps/{registry}/WEB-INF again
			</li>
			<li>
				Set a EXIST_HOME variable to the directory location of your conf.xml
			</li>
			<li>
				Now run "backupandrestore.{bat/sh} -r {backupdirectory}/db/__contents__.xml -u admin -ouri=xmldb:exist://"
			</li>
			<li>
				Your done.
			</li>
		</ul>
	  </p>
	</section>
   </body>
</document>