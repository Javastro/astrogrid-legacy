<project name="astrogrid-xmlblaster" basedir="." default="build">
  <target name="init">
    <property name="xmlblaster.home" value="${basedir}/test"/>
    
    <property name="xmlblaster.src.dir" value="${basedir}/files"/>
    <property name="xmlblaster.dst.dir" value="${xmlblaster.home}"/>
    <property name="xmlblaster.tmp.dir" value="${basedir}/tmp"/>
    
    <property name="xmlblaster.jdbc.database" value="xmlblasterantdb"/>
    <property name="xmlblaster.jdbc.url" value="jdbc:postgresql://localhost/${xmlblaster.jdbc.database}"/>
    <property name="xmlblaster.jdbc.user" value="xmlblasterantuser"/>
    <property name="xmlblaster.jdbc.password" value="xmlpass"/>
    
    <property name="postgres.jdbc.url" value="jdbc:postgresql://localhost"/>
    <property name="postgres.jdbc.user" value="postgres"/>
    <property name="postgres.jdbc.password" value=""/>
    <property name="postgres.jdbc.driver" value="org.postgresql.Driver"/>
    <property name="postgres.jdbc.classpath" value="${xmlblaster.dst.dir}/lib/pg73b1jdbc3.jar"/>

    <property name="postgres.xmlblaster.src" value="create-database-and-user.sql"/>
    <property name="postgres.xmlblaster.sql" value="${xmlblaster.dst.dir}/${postgres.xmlblaster.src}"/>

    <property name="postgres.conf.src" value="new_pg_hba.conf"/>
    <property name="postgres.conf" value="${xmlblaster.dst.dir}/${postgres.conf.src}"/>

    <property name="postgres.ip.address" value="127.0.0.1"/>
    <property name="postgres.ip.mask" value="255.0.0.0"/>
  </target>
  
  <target name="install" depends="init">
    <mkdir dir="${xmlblaster.home}"/>
    <mkdir dir="${xmlblaster.dst.dir}"/>
    <mkdir dir="${xmlblaster.tmp.dir}"/>
    
    <echo message="postgres sql file: ${postgres.xmlblaster.sql}"/>

    <copy todir="${xmlblaster.dst.dir}">
      <fileset dir="${xmlblaster.src.dir}">
        <exclude name="xmlBlaster.properties"/>
        <exclude name="${postgres.xmlblaster.src}"/>
        <exclude name="${postgres.conf.src}"/>
      </fileset>
    </copy>

    <copy todir="${xmlblaster.dst.dir}">
      <fileset dir="${xmlblaster.src.dir}">
        <include name="xmlBlaster.properties"/>
        <include name="${postgres.xmlblaster.src}"/>
        <include name="${postgres.conf.src}"/>
      </fileset>
      
      <filterset>
        <filter token="XMLBLASTER.JDBC.URL" value="${xmlblaster.jdbc.url}"/>
        <filter token="XMLBLASTER.JDBC.USER" value="${xmlblaster.jdbc.user}"/>
        <filter token="XMLBLASTER.JDBC.PASSWORD" value="${xmlblaster.jdbc.password}"/>
        <filter token="XMLBLASTER.JDBC.DATABASE" value="${xmlblaster.jdbc.database}"/>
        <filter token="IP.ADDRESS" value="${postgres.ip.address}"/>
        <filter token="IP.MASK" value="${postgres.ip.mask}"/>
      </filterset>
    </copy>
    
    <chmod dir="${xmlblaster.dst.dir}" perm="ugo+rx" includes="*.sh"/>
    
    <sql driver="${postgres.jdbc.driver}"
         url="${postgres.jdbc.url}"
         userid="${postgres.jdbc.user}"
         password="${postgres.jdbc.password}"
         src="${postgres.xmlblaster.sql}"
         classpath="${postgres.jdbc.classpath}"
         autocommit="true"
         onerror="continue"/>
    
    <echo message=""/>
    <echo message="***"/>
    <echo message="***MANUAL STEP***"/>
    <echo message="- check ${postgres.conf} and alter if necessary"/>
    <echo message="- append ${postgres.conf} to PostgreSQL pg_hba.conf"/>
    <echo message="- run pg_ctl reload as PostgreSQL superuser"/>
    <echo message="***MANUAL STEP***"/>
    <echo message="***"/>
    <echo message=""/>
  </target>
</project>
