<?xml version="1.0"?>
<!-- extension maven script -->
<project xmlns:j="jelly:core" xmlns:maven="jelly:maven" xmlns:deploy="deploy" default="astrogrid-install-snapshot">
<!-- standard astrogrid goals - defined in server project -->
  <!-- war packaging -->
  <!-- this is the name of the goal that does the packaging in the parent project.
  it's hooked into the war build as a pregoal to war:war
  because of a quirk of inheritance, its necessary to redefine this goal, rather than
  adding a new hook - otherwise the inherited hook/goal will be run too, with hilarious concequences.
  -->
  <goal name="package-war">
        <attainGoal name="merge-common-webapp" />
        <attainGoal name="configure-webapp" />
        <attainGoal name="copy-resources" />
        <attainGoal name="webapp-docs"  />
  </goal>
  <goal name="merge-common-webapp" description="copy contents of existing war into the webapp directory">
     <deploy:copy-deps todir="${working.dir}" />
     <unwar dest="${maven.war.webapp.dir}">
        <fileset dir="${working.dir}"><!-- select the file to unzip -->
                <include name="astrogrid-cea-server-*.war" />
        </fileset>
        <patternset><!-- what to unzip -->
                <exclude name="WEB-INF/classes/*/**" /> <!-- keep resources in root... -->
                <exclude name="WEB-INF/lib/**" />
                <exclude name="provider/**" />
        				<exclude name="WEB-INF/web.xml"/> <!-- use web.xml from this sub-project, not from parent project -->
        </patternset>
     </unwar>
  </goal>

  <goal name="configure-webapp" description="Configure logging">
    <replace file="${maven.war.webapp.dir}/WEB-INF/classes/log4j.properties">
       <replacefilter token="cea" value="cea-commandline" />
       <replacefilter token="CEA" value="CEA_COMMANDLINE" />
    </replace>
  </goal>

  <goal name="copy-resources" description="add other stuff to webapp" >
	<!--should probably be able to do this in the project.xml-->
    <echo message="copying across configuration utils and database schema" />
    <copy todir="${maven.war.webapp.dir}/provider/config" overwrite="yes">
      <fileset dir="${basedir}/src/sql" />
      <fileset dir="${basedir}/config" />
	  <!--also copy the test application-->
	  <fileset dir="${basedir}/test/java/app"/>
 	  <fileset dir="${basedir}/test/java/">
		 <include name="TestApplicationConfig.xml"/>
	   </fileset>
      <fileset dir="${basedir}">
        <include name="antutils.xml" />
      </fileset>
    </copy>

    <echo message="copying across a test application" />
    <copy todir="${maven.war.webapp.dir}/provider/test" overwrite="yes">
      <fileset dir="${basedir}/test/java">
        <include name="app/**" />
        <!--<include name="config/**" />-->
      </fileset>
     </copy>
  </goal>
  
   <goal name="webapp-docs" prereqs="grab-resources">
        <echo>generating webapp site into ${maven.war.webapp.dir}</echo>
   	    <property name="tmp.docs" location="${maven.build.dir}/tmp/webapp-xdocs" />
        <mkdir dir="${tmp.docs}" />
        <copy todir="${tmp.docs}" >
                <fileset dir="${basedir}/war-xdocs" />
        </copy>
        <!-- merge in anything else from site xdocs, and
         the resources we grabbed previously. -->
        <copy todir="${tmp.docs}" overwrite="false">
                <fileset dir="${working.dir}">
                        <include name="wsdl/**" />
                        <include name="schema/**" />
                </fileset>
                <fileset dir="${basedir}/xdocs" >
					<exclude name="**/navigation.xml"/>
			    </fileset>			 
        </copy>
         <!-- set up properties -->
        <j:set var="maven.docs.dest" value="${maven.war.webapp.dir}" />
        <j:set var="maven.docs.src" value="${tmp.docs}" />
        <j:set var="maven.xdoc.poweredby.title" value="Provided by Astrogrid" />
        <j:set var="maven.xdoc.poweredby.url" value="http://www.astrogrid.org" />
        <j:set var="maven.xdoc.poweredby.image" value="http://www.astrogrid.org/images/AGlogo" />
        <j:set var="maven.xdoc.includeProjectDocumentation" value="no" />
        <attainGoal name="xdoc:generate-from-pom" />
        <attainGoal name="javadoc:generate" />
        <attainGoal name="maven-jxr-plugin:report" />
        <attainGoal name="xdoc" />
        <!-- now copy generated docs into webapp -->
   </goal>


<!-- end of the war packaging -->

<!--hook into testing - need to make application executable before unit tests are run -->
  <postGoal name="test:test-resources">
    <j:choose><!--only do this when we're not skipping tests - hard to express 'not -->
        <j:when test="${maven.test.skip}" />
        <j:otherwise>
                <chmod perm="+x" file="${basedir}/target/test-classes/app/testapp.sh" />
        </j:otherwise>
    </j:choose>
  </postGoal>

  <!-- redefine goal 'force.compile.tests' - as we don't want it to happen in this project -->
  <goal name="force.compile.tests" />
	
	
	<!-- After building the web-site with the documentation, the download document needs to be
	     updated with the version and build numbers. This is done in the XHTML output, instead
	     of in the xdoc input, so as to keep the build idempotent. Note that the links built
	     in the download document will be broken until this build is loaded onto the AstroGrid
	     software site. -->
  <postGoal name="xdoc">
  	<!-- Use an ant filter to replace the version-number token with its value. Use the 
  	     ant move task, "moving" the file to its current location, to activate the filter. -->
  	<move file="${maven.docs.dest}/DOWNLOAD.html" 
  		    tofile="${maven.docs.dest}/DOWNLOAD-versioned.html" 
  		    filtering="true"
  		    failonerror="false">
  		<filterset>
  			<filter token="astrogrid.applications.version" value="${astrogrid.applications.version}"/>
  		</filterset>
  	</move>
  	<move file="${maven.docs.dest}/DOWNLOAD-versioned.html" 
  		tofile="${maven.docs.dest}/DOWNLOAD.html" 
  		filtering="false"
  		failonerror="false"/>
  </postGoal>


</project>