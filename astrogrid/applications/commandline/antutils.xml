<project name="applications-integration" default="initialize" >
<description >This file contains some admistrative tasks to help installing/running the project</description>

   <!-- ================ Hsqldb tasks ================ -->
    <!--+
        | Hsqldb properties.
        +-->
    <property file="${user.home}/build.properties"  ></property>
    <property name="hsqldb.home"     value="${basedir}/build/db"/>
    <property name="hsqldb.host"     value="localhost"/>
    <property name="hsqldb.port"     value="9001"/>
    <property name="hsqldb.name"     value="TestDB"/>
    <property name="hsqldb.user"     value="sa"/>
    <property name="hsqldb.pass"     value="veritas"/>
    <property name="hsqldb.timeout"  value="60"/>
    <property name="tomcat.home" location="/usr/local/tomcat"></property>
    <property name="appcon.webapp.home" value="${tomcat.home}/webapps/astrogrid-applications"></property>

    <property name="hsqldb.url"      value="jdbc:hsqldb:/home/applications/db/appcon"/>
<!--    <property name="hsqldb.url"      value="jdbc:hsqldb:hsql://${hsqldb.host}:${hsqldb.port}"/> -->

     <target name="initialize">
        <antcall target="hsqldb.database.create"></antcall>
        <copy file="${appcon.webapp.home}/test/app/testapp.sh" todir="${basedir}/tools/"></copy>
        <chmod file="${basedir}/tools/testapp.sh" perm="ugo+rx"/>
        <copy file="${appcon.webapp.home}/ApplicationControllerDelegate.jar" todir="${basedir}/tools/"></copy>
        
     </target>
    
    <target name="show" depends="axis.tasks">
    <property name="testprop" refid="testpath"></property>
    <echo >
    tomcat home =${tomcat.home}
    hsqldb home =${hsqldb.home}
    path = ${testprop}
    </echo>
    </target>

    <!--+
        | The Hsqldb library classpath.
        +-->
    <path id="hsqldb.classpath">
       <!-- <pathelement location="${jar.cache.local}/hsqldb/jars/hsqldb-${hsqldb.version}.jar"/> -->
       <pathelement location="${hsqldb.jar.path}"/>
    </path>

    <!--+
        | Create the Hsqldb server properties.
        | Can be overriden by command line args in hsqldb.start.
        +-->
    <target name="hsqldb.properties" depends="">
        <echo message=""/>
        <echo message="Creating Hsqldb properties ...."/>
        <mkdir dir="${hsqldb.home}"/>
        <!-- Create the properties file -->
        <propertyfile file="${hsqldb.home}/server.properties" comment="Hqsldb server config">
            <entry key="server.port"           value="${hsqldb.port}"/>
            <entry key="server.database"       value="${hsqldb.name}"/>
            <entry key="server.no_system_exit" value="true"/>
        </propertyfile>
    </target>

    <!--+
        | Start the Hsqldb database server.
        +-->
    <target name="hsqldb.start" depends="">
        <echo message=""/>
        <echo message="Starting Hqsldb ...."/>
        <mkdir dir="${hsqldb.home}"/>
        <java taskname="hsqldb" classname="org.hsqldb.Server" fork="true" dir="${hsqldb.home}">
            <!-- Use the Hsqldb classpath -->
            <classpath refid="testpath"/>
            <!-- Args for the Hsqldb server -->
            <arg value="-database"/>
            <arg value="${hsqldb.name}"/>
            <arg value="-port"/>
            <arg value="${hsqldb.port}"/>
        </java>
    </target>

    <!--+
        | Stop the Hsqldb database server.
        +-->
    <target name="hsqldb.stop" depends="">
        <echo message=""/>
        <echo message="Stopping Hqsldb ...."/>
        <java taskname="hsqldb" classname="org.hsqldb.util.ShutdownServer" fork="true" dir="${hsqldb.home}">
            <!-- Use the Hsqldb classpath -->
            <classpath refid="testpath"/>
            <!-- Args for the Hsqldb server -->
            <arg value="-url"/>
            <arg value="${hsqldb.url}"/>
            <arg value="-user"/>
            <arg value="${hsqldb.user}"/>
            <arg value="-password"/>
            <arg value="${hsqldb.pass}"/>
            <arg value="-shutdownarg"/>
            <arg value=""/>
        </java>
    </target>

    <!--+
        | Wait for the Hsqldb database to start.
        +-->
    <target name="hsqldb.wait" depends="">
        <echo message=""/>
        <echo message="Waiting for Hqsldb ...."/>
        <waitfor maxwait="${hsqldb.timeout}" maxwaitunit="second" checkevery="500">
            <socket server="${hsqldb.host}" port="${hsqldb.port}"/>
        </waitfor>
    </target>

    <!--+
        | Initialise the Hsqldb database.
        | This only needs to run once, when a new database is created.
        +-->
    <target name="hsqldb.init" depends="">
        <echo message=""/>
        <echo message="Initialising Hqsldb ...."/>
        <sql driver="org.hsqldb.jdbcDriver"
             url="${hsqldb.url}"
             classpathref="testpath"
             userid="sa"
             password=""
             print="true"
            >
            <![CDATA[
                set password "${hsqldb.pass}" ;
            ]]>
        </sql>
    </target>

    <!--+
        | Delete our Hsqldb data.
        +-->
    <target name="hsqldb.delete" depends="">
        <delete dir="${hsqldb.home}" failonerror="false"/>
    </target>

    <!--+
        | Build our Hsqldb database.
        +-->
    <target name="hsqldb.BUILD" depends="">
        <antcall target="hsqldb.wait"/>
        <antcall target="hsqldb.init"/>
        <antcall target="hsqldb.database.create"/>
    </target>


    <!-- ================ Database tasks ================ -->
    <!--+
        | Create our database tables.
        +-->
    <target name="hsqldb.database.create" depends="">
        <echo message=""/>
        <echo message="Creating Hqsldb tables ...."/>
        <antcall target="hsqldb.init"/>
        <sql driver="org.hsqldb.jdbcDriver"
             url="${hsqldb.url}"
             classpathref="testpath"
             userid="${hsqldb.user}"
             password="${hsqldb.pass}"
             print="true"
            >
            <transaction src="${appcon.webapp.home}/config/createcontroldb.sql"/>
        </sql>
    </target>

    <!--+
        | Select all rows from our database tables.
        +-->
    <target name="hsqldb.database.select" depends="">
        <sql driver="org.hsqldb.jdbcDriver"
             url="${hsqldb.url}"
             classpathref="testpath"
             userid="${hsqldb.user}"
             password="${hsqldb.pass}"
             print="true"
            >
            <![CDATA[
                SELECT * FROM exestat ;
            ]]>
        </sql>
    </target>

    <!--+
        | Delete all rows from our database tables.
        +-->
    <target name="hsqldb.database.delete" depends="">
        <sql driver="org.hsqldb.jdbcDriver"
             url="${hsqldb.url}"
             classpathref="testpath"
             userid="${hsqldb.user}"
             password="${hsqldb.pass}"
             print="true"
            >
            <![CDATA[
                DELETE FROM exestat      ;
           ]]>
        </sql>
        
    </target>
    
    <target name="testsetup">
    </target>
    
    <path id="testpath">
    <fileset dir="${tomcat.home}/common/lib" includes="*.jar"/>
    <fileset dir="${tomcat.home}/common/endorsed" includes="*.jar"/>
    <fileset dir="${appcon.webapp.home}/WEB-INF/lib/" includes="*.jar"/>
    <fileset dir="${basedir}" includes="*.jar"/>
    </path>
    
    <target name="quicktest">
    <java classname="org.astrogrid.applications.delegate.TestApplicationControllerDelegate" >

       <classpath refid="testpath"></classpath>
    </java>
    </target>
    
    
    <target name="service.deploy" depends="axis.tasks">
        <!-- Deploy our authenticationService service -->
        <axis.admin
            port="8080"
            hostname="localhost"
            servletpath="/astrogrid-applications/services/AdminService"
            debug="true"
            xmlfile="${appcon.webapp.home}/config/wsdd/ApplicationControllerService/deploy.wsdd"
            />
    </target>
    
    <target name="axis.tasks" depends="">
        <taskdef name="axis.admin" classname="org.apache.axis.tools.ant.axis.AdminClientTask">
            <classpath>
                <!-- Our Axis libraries -->
                <path refid="testpath"/>
            </classpath>
        </taskdef>
        <taskdef name="axis.wsdl2java" classpathref="testpath" classname="org.apache.axis.tools.ant.wsdl.Wsdl2javaAntTask"/>
        <taskdef name="axis.java2wsdl" classpathref="testpath" classname="org.apache.axis.tools.ant.wsdl.Java2WsdlAntTask"/>
    </target>
    
    
 
</project>