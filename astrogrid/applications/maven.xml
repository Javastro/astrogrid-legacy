<?xml version="1.0" ?>
<!-- extension maven script -->
<project xmlns:j="jelly:core"  xmlns:maven="jelly:maven" xmlns:deploy="deploy" default="jar:jar">
<!-- location of generated source tree -->
<property name="generated.src" location="${basedir}/generated/java" />
<property name="generated.dir" location="${basedir}/generated" />
<!-- Tomcat properties -->
<property name="appint.webapp.name" value="${pom.artifactId}"/><!-- use the standard application id -->
<property name="appint.service.name" value="ApplicationControllerService"/>
<property name="tomcat.host" value="localhost"/>
<property name="tomcat.port" value="8080"/>

<property name="tomcat.url" value="http://${tomcat.host}:${tomcat.port}"/>
<property name="tomcat.manager.url" value="${tomcat.url}/manager"/>

<property name="working.dir"     value="${basedir}/build/"/>

 <!-- Axis properties-->
<property name="axis.base"     value="${working.dir}/axis"/>
<property name="axis.webapp.srcdir"  value="${axis.base}/${appint.webapp.name}"/>
<property name="axis.url"     value="${tomcat.url}/${appint.webapp.name}"/>
<property name="axis.timeout" value="60"/>

<!-- this classpath comes from the files that are extracted from the axis distro / could this be shortened with a fileset?-->
    <path id="axis.classpath">
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/axis.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/axis-ant.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/saaj.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/wsdl4j.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/jaxrpc.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/commons-logging.jar"/>
        <pathelement location="${axis.webapp.srcdir}/WEB-INF/lib/commons-discovery.jar"/>
    </path>
    
<property name="maven.war.src" value="${axis.webapp.srcdir}"/> 
<property name="maven.war.webapp.dir" location="${maven.build.dir}/${pom.artifactId}" /> <!-- set this early to default - does not seem to be set n the war:webapp post goal -->

<goal name="astrogrid-clean" prereqs="clean"/>

<goal name="astrogrid-deploy-site">
	    <mkdir dir="${maven.build.dest}" />
	    <attainGoal name="site" /><!-- NWW: added - necessary, as site:fsdeploy won't do it by itself -->
		<attainGoal name="site:fsdeploy" />
</goal>

<goal name="astrogrid-install-snapshot">
        <maven:maven descriptor="${basedir}/delegate-project.xml" goals="jar:install-snapshot" />
        <attainGoal name="jar:install-snapshot" />
        <attainGoal name="war:install-snapshot" />
</goal>
<goal name="astrogrid-deploy-snapshot">
		<maven:maven descriptor="${basedir}/delegate-project.xml" goals="jar:deploy-snapshot" />
        <attainGoal name="jar:deploy-snapshot" />
        <attainGoal name="war:deploy-snapshot" />
</goal>
<goal name="astrogrid-deploy-artifact" prereqs="jar:deploy,war:deploy"/>


	<preGoal name="war:init">
	   <!-- make sure that the latest axis is in place necessary for the maven install -->
	   <attainGoal name="axis.unpack" /> 
	</preGoal>
	<postGoal name="war:webapp">
	    <attainGoal name="grab-schema" />
	    <attainGoal name="delegatejar" />
		<echo message="copying cvs webapp stuff on top"/>
  <!-- make sure that the cvs maven stuff is put into the webapp - because the axis dir is regarded as source for the war goal-->
        <copy todir="${maven.war.webapp.dir}" overwrite="yes">
        <fileset dir="${basedir}/src/webapp"></fileset>
        </copy>
		<echo message="Copying generated site ${maven.docs.dest} across to webapp ${maven.war.webapp.dir}/maven"/>
		
		<copy todir="${maven.war.webapp.dir}/maven" overwrite="yes">
			<fileset dir="${maven.docs.dest}"/>
		</copy>
		
		<copy todir="${maven.war.webapp.dir}" overwrite="yes">
			<fileset dir="${maven.build.dir}" includes="CommonExecutionConnectorDelegate.jar" />
			<fileset dir="${working.dir}" >
			    <include name="schema/**"/>
			    <include name="wsdd/**"/>
			    <include name="wsdl/**"/>
			</fileset>
		</copy>
		
		<echo message="copying across configuration utils and  database schema"/>
		
		<copy todir="${maven.war.webapp.dir}/config" overwrite="yes">
			<fileset dir="${basedir}/src/sql">
			</fileset>
		    <fileset dir="${basedir}/config" />				
			<fileset dir="${basedir}"> <include name="antutils.xml"/></fileset>
		</copy>
		
		<echo message="copying across a test application - ${maven.test.dest}"/>
		
		<copy todir="${maven.war.webapp.dir}/test" overwrite="yes">
		    <fileset dir="${basedir}/test">
		       <include name="app/**"/>
		       <include name="config/**"/>
		    </fileset>
		    <!-- also get the test.properties from the test area-->
		    <fileset dir="${maven.test.dest}">
		       <include name="Test.properties" />
		    </fileset>
		</copy>
	<attainGoal name="configure-webapp" />
 		<!-- TODO - need to add links to the actual applications -->
	</postGoal>

<!-- hooks into existing goals -->
  <preGoal name="java:compile"><!-- generate classes from schema and wsdl first -->
   <!-- don't generate in this project any longer - all in the workflow-objects folder.   
     <mkdir dir="${generated.src}" />
     <path id="generated.src.path" location="${generated.src}"/>
    <maven:addPath id="maven.compile.src.set" refid="generated.src.path"/>  
    -->
    <maven:addPath id="maven.dependency.classpath" refid="axis.classpath"/>
<!-- don't do this for now....
  	-->
  </preGoal>

<!-- add the extra paths for site generate too -->  
  <preGoal name="site:generate" >
    <maven:addPath id="maven.dependency.classpath" refid="axis.classpath"/>
  </preGoal>

<!-- set up the test environment -->
<preGoal name="test:test">
   <mkdir dir="${working.dir}/workdir"/>
   <mkdir dir="${working.dir}/db"/>
</preGoal>

<preGoal name="test:test-resources">
    <!--set up the test environment - need to grab schema and wsdd from the workflow objects and set up any test properties files-->
    <attainGoal name="grab-schema" />
    <echo message="creating the test properties file"/>
   <!-- need to generate the Test.properties file to put the correct paths in -->
<copy file="${basedir}/test/java/Test.preprop" tofile="${basedir}/test/java/Test.properties" overwrite="true"/>


<echo file="${basedir}/test/java/Test.properties" append="true">
DBCreationScript=${basedir}/src/sql/createcontroldb.sql
WorkingDirectory=${working.dir}/workdir
ApplicationConfigFile=file://${basedir}/test/config/TestApplicationConfig.xml
RegistryTemplate=file://${basedir}/config/CEARegistryTemplate.xml
</echo>
</preGoal>


<!-- new goals -mainly for wsdl and stub generation-->

  <goal name="generate-wsdl" description="generate the wsdl from the classes" prereqs="axis-declare-tasks, java-compile-for-wsdl">
    <maven:addPath id="maven.dependency.classpath" refid="axis.classpath"/>
  	<delete><!-- clean out to start with -->
  	     <!-- need to save the server side skeleton -->
		<fileset dir="${generated.src}" >
			<include name="**/*.java" />
			<include name="**/*.class" />
			<include name="**/*.wsdd" />
			<include name="**/*.wsdl" />
		</fileset>
	</delete>
  <mkdir dir="${generated.dir}/wsdl" />
	<attainGoal name="java2wsdl" />
	      
  </goal>
  <goal name="java-compile-for-wsdl" prereqs="clean">
     <echo message="${maven.build.dest}" />
     <mkdir dir="${maven.build.dest}"/>
     <javac srcdir="${basedir}/src/java"
            destdir="${maven.build.dest}"
            classpathref="maven.dependency.classpath"
            debug="on"
            target="1.4"
            source="1.4">
            <exclude name="**/delegate/**"/>
            <exclude name="**/avodemo/**"/> 
     </javac>
  </goal>

   
   <goal name="java2wsdl" prereqs="axis-declare-tasks">
     <maven:addPath id="maven.dependency.classpath" refid="axis.classpath"/>
   <axis-java2wsdl output="${generated.dir}/wsdl/${appint.service.name}.wsdl"
            classname="org.astrogrid.applications.manager.Tmp"
            location="${axis.url}/services/${appint.service.name}"
            namespace="urn:manager.applications.astrogrid.org"
            namespaceimpl="urn:impl.manager.applications.astrogrid.org"
            implclass="org.astrogrid.applications.manager.CommandLineApplicationController"
            style="WRAPPED"
            use="LITERAL"
   >
            <!-- The classpath to find the applicationServerService classes -->
            <classpath>
                <path location="${maven.build.dest}"/>
                <path refid="maven.dependency.classpath"/> <!-- for things in the common jar -->
            </classpath>
            <mapping package="org.astrogrid.applications" namespace="urn:beans.applications.astrogrid.org" />
            <mapping package="org.astrogrid.applications.description" namespace="urn:beans.applications.astrogrid.org" />
            
   </axis-java2wsdl>
   </goal> 
     
   <property name="wsdl.file" value="${generated.dir}/wsdl/${appint.service.name}.wsdl"/>
   


<!-- stand - alone goals - not addons to main build -->
     <goal name="showconfig" description="A goal to show important configuration settings">
 		<echo message="tomcat.home    : ${tomcat.home}"/>
		<echo message="tomcat.manager.username     : ${tomcat.manager.username}"/>
		<echo message="tomcat.manager.password     : ${tomcat.manager.password}"/>
		<echo message="maven.war.src               : ${maven.war.src}"/>
		<echo message="maven.build.dir               : ${maven.build.dir}"/>
        <property name="project.class.path.string" refid="maven.dependency.classpath"/>
        <echo>maven.dependency.classpath=${project.class.path.string}</echo>

 		<echo message=""/>
    </goal>

<!-- tasks for deployment / distribution -->
    <goal name="axis.unpack" description="download the full axis distribution and unpack it. ">
        <delete dir="${axis.base}"/>        
        <mkdir dir="${axis.base}"/>
        <!-- there must be a way to reference this directly surely? does it use the JSTL expression language? what is the key?-->
        <j:forEach var="deps" items="${pom.artifacts}">
         <j:if test="${deps.dependency.artifactId=='axisfull' &amp;&amp; deps.dependency.type=='zip'}">
         <echo message="found full axis distribution"/>
          <unzip src="${deps.path}" dest="${axis.base}" >
          <patternset>
            <include name="**/webapps/**" />
          </patternset>
          </unzip>
          </j:if>
        </j:forEach>
        <echo message="${axis.webapp.srcdir}" />
        <mkdir dir="${axis.webapp.srcdir}" />
        <!--move the webapps stuff into the correct place -->
         <move  todir="${axis.webapp.srcdir}" >
           <fileset dir="${axis.base}/axis-1_1/webapps/axis" >
                        <exclude name="**/samples/**"/>
           </fileset>
         </move>
            <!-- 
        -->
        
    </goal>
<goal name="grab-schema" description="grab schema, wsdl from workflow-objects">
        <echo> grabbing schema, wsdd and wsdl from workflow-object.jar</echo>
        <mkdir dir="${working.dir}" />
        <deploy:copy-deps todir="${working.dir}" />
        <unjar dest="${working.dir}" overwrite="true">
                <fileset dir="${working.dir}">
                        <include name="*workflow-objects*.jar" /> <!-- should eget the exact jar dep name -->
                </fileset>
                <patternset>
                        <include name="wsdd/**" />
                        <include name="schema/**" />
                        <include name="wsdl/**" />
                </patternset>
        </unjar>
        <!-- clean up rest of stuff -->
        <delete>
                <fileset dir="${working.dir}">
                        <include name="*.jar" />
                </fileset>
        </delete>
</goal>
 
 
 <goal name="configure-webapp" prereqs="axis.unpack" description="assemble individual wsdd into server-config.wsdd">
 	<!-- -->
 	<attainGoal name="grab-schema" />
	 <path id="fullapppath">
	        <fileset dir="${maven.war.webapp.dir}/WEB-INF/lib/" includes="*.jar"/>
	        <dirset dir="${maven.war.webapp.dir}/WEB-INF/classes/"/>
	    
	 </path>
	 <java classname="org.apache.axis.utils.Admin"
            dir="${maven.war.webapp.dir}/WEB-INF"
            classpathref="fullapppath" fork="yes" failonerror="true">
        <arg value="server"/>
        <arg value="${working.dir}/wsdd/CommonExecutionConnector-deploy.wsdd"/>
	</java>
	
<!--Try noels way...          
        ${systemScope.setProperty('javax.xml.transform.TransformerFactory','org.apache.xalan.processor.TransformerFactoryImpl')}
        <xslt in="${working.dir}/wsdd/CommonExecutionConnector-deploy.wsdd"
              out="${maven.war.webapp.dir}/WEB-INF/server-config.wsdd"
              extension=".wsdd"
              style="${basedir}/src/xslt/server-config.xsl"
        />
 -->

</goal>
    
    <goal name="webapp.install" prereqs="tomcat-declare-tasks">
         <echo message="installing applications integration webapp (with axis)"/>
        <tomcat-install username="${tomcat.manager.username}" password="${tomcat.manager.password}" url="${tomcat.manager.url}" path="/${appint.webapp.name}" war="file://${maven.build.dir}/${appint.webapp.name}"/>
    </goal>
    
    <goal name="service-deploy" prereqs="axis-declare-tasks">
         <axis-admin
            port="${tomcat.port}"
            hostname="${tomcat.host}"
            servletpath="/${appint.webapp.name}/services/AdminService"
            debug="true"
            xmlfile="${working.dir}/wsdd/CommonExecutionConnector-deploy.wsdd"
            />
    </goal>

   <goal name="builddelegate" >
   		<!--build and depoly the delegate jar - would really like to pass properties to this maven project to put the classes elsewhere, but it does not seem immediately possible from the -->
		<maven:maven descriptor="${basedir}/delegate-project.xml" goals="jar:deploy-snapshot"/>
   	
   </goal>

    <goal name="delegatejar" prereqs="java:compile,test:compile">
    	
    <!--This is now really obsolete - the separate project should be used, and copy that dependency jar...need the workflow-objects too...
    	 would be nice to have -${pom.currentVersion} in name, but cannot with cvs tag stuff - need to think of something better-->
         <jar destfile="${maven.build.dir}/CommonExecutionConnectorDelegate.jar">
            <fileset dir="${maven.build.dest}">
               <include name="**/delegate/**" />
            </fileset>
            <fileset dir="${maven.test.dest}">
               <include name="**/delegate/**" />
            </fileset>
            
         </jar>
    </goal>
    <goal name="webapp.patch" prereqs="java:compile">
        <copy todir="${maven.war.webapp.dir}/WEB-INF/classes">
          <fileset dir="${maven.build.dir}/classes"/>
        </copy>
        <copy todir="${maven.war.webapp.dir}/">
          <fileset dir="src/webapp">
          <exclude name="WEB-INF/**"/>
          </fileset>
        </copy>
        
    </goal>
<!-- boilerplate below here -->

  
-->
  <goal name="axis-declare-tasks">
     <taskdef resource="axis-tasks.properties"   inheritRefs="true" >
           <classpath>
                <path refid="maven.dependency.classpath"/> 
                <path refid="axis.classpath" />
            </classpath>    
     </taskdef>
  </goal>

<!-- tomcat tools -->
<goal name="tomcat-declare-tasks">
   <maven:addPath id="maven.dependency.classpath" refid="axis.classpath"/>
  
   <!-- Configure the custom Ant tasks for the Manager application -->
  <taskdef name="tomcat-deploy"    classname="org.apache.catalina.ant.DeployTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-install"   classname="org.apache.catalina.ant.InstallTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-list"      classname="org.apache.catalina.ant.ListTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-reload"    classname="org.apache.catalina.ant.ReloadTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-remove"    classname="org.apache.catalina.ant.RemoveTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-resources" classname="org.apache.catalina.ant.ResourcesTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-roles"     classname="org.apache.catalina.ant.RolesTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-start"     classname="org.apache.catalina.ant.StartTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-stop"      classname="org.apache.catalina.ant.StopTask" classpathref="maven.dependency.classpath"/>
  <taskdef name="tomcat-undeploy"  classname="org.apache.catalina.ant.UndeployTask" classpathref="maven.dependency.classpath"/>
</goal>


</project>
